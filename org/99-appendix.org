** Quick Reference

This appendix contains tool references, cheatsheets, and common operations.

* Appendix A: Emacs Quick Reference

** Essential Commands

*** Most Used Commands

| Command     | Action                          |
|-------------|---------------------------------|
| =C-c C-c=   | Execute code block at cursor    |
| =C-c C-v t= | Tangle (generate all files)     |
| =C-x C-s=   | Save file                       |
| =C-x C-c=   | Quit Emacs                      |
| =C-g=       | Cancel/abort command            |

*** Navigation

| Command   | Action                    |
|-----------|---------------------------|
| =C-n=     | Next line (or arrow down) |
| =C-p=     | Previous line (or up)     |
| =C-f=     | Forward char (or right)   |
| =C-b=     | Backward char (or left)   |
| =C-a=     | Beginning of line         |
| =C-e=     | End of line               |
| =M-<=     | Beginning of file         |
| =M->=     | End of file               |
| =C-v=     | Page down                 |
| =M-v=     | Page up                   |

*** Org-mode Navigation

| Command     | Action                  |
|-------------|-------------------------|
| =TAB=       | Fold/unfold section     |
| =S-TAB=     | Fold/unfold all         |
| =C-c C-n=   | Next heading            |
| =C-c C-p=   | Previous heading        |
| =C-c C-u=   | Up to parent heading    |
| =C-c C-o=   | Open link at cursor     |

*** Search

| Command | Action                                    |
|---------|-------------------------------------------|
| =C-s=   | Search forward (press again for next)     |
| =C-r=   | Search backward                           |
| =C-g=   | Cancel search                             |

*** Editing

| Command     | Action                        |
|-------------|-------------------------------|
| =C-d=       | Delete character              |
| =M-d=       | Delete word                   |
| =C-k=       | Kill (cut) to end of line     |
| =C-y=       | Yank (paste)                  |
| =C-/=       | Undo                          |
| =C-Space=   | Set mark (start selection)    |
| =C-w=       | Kill region (cut selection)   |
| =M-w=       | Copy region                   |

*** Windows/Buffers

| Command | Action                              |
|---------|-------------------------------------|
| =C-x 2= | Split window horizontally           |
| =C-x 3= | Split window vertically             |
| =C-x 1= | Close other windows (keep current)  |
| =C-x 0= | Close current window                |
| =C-x o= | Switch to other window              |
| =C-x b= | Switch buffer                       |

*** Help

| Command | Action                              |
|---------|-------------------------------------|
| =C-h t= | Emacs tutorial                      |
| =C-h k= | Describe key (what does key do?)    |
| =C-h f= | Describe function                   |
| =C-h v= | Describe variable                   |

** Working with This Document

*** Typical Workflow

1. Open: =emacs -nw org/install.org=
2. Navigate: Use =C-c C-n= to jump between phases, =TAB= to expand sections
3. Read: Understand what each phase does
4. Customize: Edit Phase 0 configuration values
5. Execute: Either:
   - Run blocks individually: Place cursor in block, press =C-c C-c=
   - Or generate everything: Press =C-c C-v t= to tangle
6. Save: =C-x C-s=
7. Exit: =C-x C-c=

*** Testing Individual Blocks

You can execute any code block without tangling:
1. Place cursor inside the code block
2. Press =C-c C-c=
3. Output appears below (for shell blocks)

Useful for testing before full deployment.

*** Understanding Tangle Directives

Code blocks have =:tangle= directives:

#+begin_example
#+begin_src yaml :tangle ../ansible/playbook.yml
# This code will be extracted to ansible/playbook.yml
#+end_src
#+end_example

When you press =C-c C-v t=, all blocks are extracted to their tangle destinations.

*** Tips

- Use =C-s= to search for specific topics
- Use =TAB= generously to collapse sections you've read
- Keep org/install.org open in tmux - it survives SSH disconnects
- Source files (org/) are version controlled, generated files are not

** Troubleshooting Emacs

*** Can't Quit

- Try =C-x C-c=
- If stuck, press =C-g= first, then =C-x C-c=
- If still stuck, close terminal window (work is auto-saved)

*** Weird Characters Appearing

- You might be in insert mode in a terminal that's intercepting keys
- Press =ESC= then try commands again
- Or use arrow keys instead of =C-n/C-p/C-f/C-b=

*** Tangling Doesn't Work

1. Save first: =C-x C-s=
2. Check you're in org/install.org (not a sub-file)
3. Try again: =C-c C-v t=
4. Check messages at bottom of screen for errors

*** Lost Your Place

1. Press =M-<= to go to beginning
2. Or press =C-s= and search for text you remember
3. Or use =C-c C-n= to jump through headings

* Appendix B: Ansible Quick Reference

** Running Playbooks

*** Basic Execution

#+begin_example
# Full installation
cd ansible
ansible-playbook playbook.yml

# Verbose output
ansible-playbook playbook.yml -v

# Dry run (see what would change)
ansible-playbook playbook.yml --check --diff
#+end_example

*** Running Specific Phases

#+begin_example
# Single phase
ansible-playbook playbook.yml --tags monerod

# Multiple phases
ansible-playbook playbook.yml --tags "privacy,i2p,monerod"

# List available tags
ansible-playbook playbook.yml --list-tags
#+end_example

*** Available Tags

| Tag          | Phase                       |
|--------------|-----------------------------|
| =base=       | Base system setup           |
| =wireguard=  | WireGuard VPN               |
| =privacy=    | Privacy (Tor, git)          |
| =i2p=        | I2P network privacy         |
| =monerod=    | Monero full node            |
| =users=      | User accounts               |
| =mining=     | Mining (P2Pool + XMRig)     |
| =firewall=   | Firewall setup              |
| =monitoring= | Monitoring                  |
| =backup=     | Backup configuration        |
| =verify=     | Verification                |

** Troubleshooting Ansible

#+begin_example
# Check syntax
ansible-playbook playbook.yml --syntax-check

# Test connection
ansible localhost -m ping

# Re-run with max verbosity
ansible-playbook playbook.yml -vvvv
#+end_example

** Updating After Changes

#+begin_example
# 1. Edit org files
emacs -nw org/00-configuration.org

# 2. Tangle (in Emacs: C-c C-v t)
# Or from command line:
cd ansible && ./tangle-all.sh

# 3. Assemble playbook
./assemble-playbook.sh

# 4. Re-run Ansible
ansible-playbook playbook.yml --tags <phase>
#+end_example

* Appendix C: Quick Operations Reference

** Daily Commands

#+begin_example
# System status
sudo system-check.sh
sudo system-status.sh

# Service status
sudo monerod-status.sh
sudo i2p-status.sh
sudo mining-monitor.sh  # if mining enabled

# Logs
source /etc/profile.d/log-aliases.sh
logs-all
logs-mining

# Ban list status
tail /var/log/monero-banlist.log
sudo update-monero-banlist.sh  # Force update now
#+end_example

** Service Management

#+begin_example
sudo systemctl {start|stop|restart|status} <service>
sudo journalctl -u <service> -f
#+end_example

Services: =monerod=, =i2pd=, =tor=, =p2pool=, =xmrig=, =wg-quick@wg0=

** External Documentation

All detailed troubleshooting, commands, and configuration:

- **Monero:** https://monerodocs.org
- **I2P:** https://geti2p.net/en/docs
- **Tor:** https://support.torproject.org
- **P2Pool:** https://github.com/SChernykh/p2pool
- **Ansible:** https://docs.ansible.com
- **systemd:** =man systemctl=, =man journalctl=

* Appendix D: Emergency Procedures

** System Won't Boot

1. Boot from Omarchy USB
2. Unlock encrypted partition
3. Mount root and check logs
4. Restore from backup if needed

** Complete Data Loss

1. Reinstall Omarchy (INSTALL-OMARCHY.md)
2. Clone repository
3. =./bootstrap.sh=
4. =sudo restore.sh <backup-file>=
5. =cd ansible && ansible-playbook playbook.yml=

** Forgot Encryption Password

No recovery possible. Encryption is unbreakable by design.
Restore from off-site backup on new installation.

* Appendix E: Rollback Procedures

** General Rollback Pattern

All phases can be rolled back by:
1. Stop affected services
2. Remove installed packages/files
3. Remove systemd services
4. Remove configuration files
5. Reload systemd

#+begin_example
# Stop service
sudo systemctl stop <service>
sudo systemctl disable <service>

# Remove service file
sudo rm /etc/systemd/system/<service>.service
sudo systemctl daemon-reload

# Remove data/configs
sudo rm -rf /opt/<service>
sudo rm /etc/<service>.conf

# Remove firewall rules
sudo ufw delete allow <port>
#+end_example

** Phase-Specific Rollback

*** Phase 5: Monerod

#+begin_example
sudo systemctl stop monerod
sudo systemctl disable monerod
sudo rm /etc/systemd/system/monerod.service
sudo rm /etc/monerod.conf
sudo rm -rf /opt/monerod  # WARNING: Deletes 160GB blockchain
sudo systemctl daemon-reload
#+end_example

*** Phase 7: Mining

#+begin_example
sudo systemctl stop xmrig p2pool
sudo systemctl disable xmrig p2pool
sudo rm /etc/systemd/system/{xmrig,p2pool}.service
sudo rm -rf /opt/xmrig /opt/p2pool
sudo systemctl daemon-reload
#+end_example

*** Phase 3: Privacy (Tor)

#+begin_example
sudo systemctl stop tor
sudo systemctl disable tor
sudo rm /etc/tor/torrc
sudo rm -rf /opt/tor-browser
sudo rm /usr/local/bin/tor-browser
#+end_example

*** Phase 4: I2P

#+begin_example
sudo systemctl stop i2pd
sudo systemctl disable i2pd
sudo rm -rf /etc/i2pd/tunnels.conf.d/monero-mainnet.conf
#+end_example

** Complete System Rollback

To undo entire installation:

#+begin_example
# Stop all services
sudo systemctl stop xmrig p2pool monerod tor i2pd wg-quick@wg0

# Remove systemd services
sudo rm /etc/systemd/system/{xmrig,p2pool,monerod}.service
sudo systemctl daemon-reload

# Remove users
sudo userdel -r mining

# Remove data directories
sudo rm -rf /opt/{xmrig,p2pool,monerod,tor-browser}

# Remove configs
sudo rm /etc/{monerod,tor/torrc}.conf
sudo rm -rf /etc/wireguard

# Reset firewall
sudo ufw --force reset

# Remove scripts
sudo rm /usr/local/bin/{monerod,i2p,mining,system,wireguard}-*.sh
#+end_example

** Recovery After Failed Rollback

If rollback fails, restore from backup:

#+begin_example
sudo restore.sh /srv/backups/backup_<date>.tar.gz
#+end_example

** Using Git History

For specific file changes:

#+begin_example
# See what changed
git log --oneline org/05-monerod.org

# Revert to specific commit
git checkout <commit-hash> org/05-monerod.org

# Re-tangle and deploy
cd ansible
./tangle-all.sh
./assemble-playbook.sh
ansible-playbook playbook.yml --tags monerod
#+end_example

* Appendix F: Threat Models & Design Rationale

** System Threat Model

This system prioritizes **operational privacy** for specific activities, not theoretical anonymity from all observers.

*** What This Protects

- IP address hidden from web services (Tor routing)
- Transaction broadcast location hidden (I2P/Tor for Monero)
- Git operations routed through Tor (IP hidden from GitHub/GitLab)
- SSH connections encrypted and routed through Tor
- Browser fingerprinting minimized (Tor Browser)
- P2P connections anonymous (I2P inbound via hidden service)

*** What This Does NOT Protect

- GitHub/GitLab knows your account identity (if logged in)
- Blockchain sync uses clearnet (intentional - sybil protection)
- Commit metadata (name, email) visible in git history
- Service content is visible to hosting providers
- AI services know identity if you use paid accounts
- Package managers reveal installed software stack

*** Design Rationale

**Blockchain sync on clearnet (not Tor/I2P):**
Downloading blockchain data doesn't reveal which transactions are yours. Syncing through Tor would create sybil attack surface and slow sync significantly. Privacy comes from I2P broadcast + Tor fallback when *sending* transactions.

**Git account visible to GitHub:**
Trading operational privacy (IP hidden, git operations routed through Tor) for account-level privacy (which account owns commits). GitHub doesn't see your IP, but sees your account. This is the stated trade-off.

**Focus: Operational Privacy, Not Anonymity**
This system separates IP/location from operations and transactions. It does not pretend anonymity from institutional services you choose to use (GitHub, exchanges, etc.). Maximum privacy comes from self-hosting and P2P-only operations, which has different trade-offs.

Reference: https://github.com/monero-project/monero/blob/master/docs/ANONYMITY_NETWORKS.md

* Appendix G: Design Rationale

** Why Run Each Component

*** Monero Full Node (monerod)

- **Trustless validation:** Verify entire blockchain yourself
- **Network privacy:** Transactions broadcast via I2P (IP unlinkability)
- **No intermediaries:** Direct P2P participation, no reliance on third parties
- **Agent-ready:** Same infrastructure works for humans and autonomous agents

Resource requirements: 250GB+ disk, 2-4GB RAM, 500MB-1GB/day bandwidth, 6-24 hour initial sync.

Reference: https://monerodocs.org/interacting/monero-network-ports/

*** Mining (P2Pool + XMRig)

**Why mine:**
- Demonstrates trustless participation in Monero network
- P2Pool integration shows decentralized pool architecture
- Contributes to network security
- Mining runs at low priority - can be disabled later if desired

**P2Pool vs Traditional Pools:**

*P2Pool* is a decentralized mining pool:
- No central server
- Payouts directly from blockchain
- No pool fees (except miner donation)
- More resistant to censorship
- Requires running monerod (which we do)

*Traditional pools* are centralized:
- Operator controls payouts
- Takes fees
- Subject to regulatory pressure
- Single point of failure

P2Pool types: normal (>100 kH/s), mini (<100 kH/s, recommended), nano (experimental).

Reference: https://github.com/SChernykh/p2pool

** Security & Cryptography Decisions

*** GPG Signature Verification (Ban List)

**Why we don't verify signatures automatically:**

The ban list is cryptographically signed by MRL developers, but automated signature verification has a bootstrapping problem:

1. GPG keys must be fetched from same potentially compromised sources as ban list
2. If GitHub is compromised to serve malicious ban lists, it's also compromised to serve malicious GPG keys
3. Automated signature verification provides no additional security over HTTPS alone

**Our approach:**
- HTTPS transport security (GitHub's TLS protects download integrity)
- Size validation (>50% change triggers manual review, detects corruption/attacks)
- Manual GPG verification available for high-security operators

This is pragmatic security: automated signatures add complexity without meaningful protection. Manual verification remains available for those who need it.

Manual verification: https://github.com/Boog900/monero-ban-list#signatures

*** XMRig MSR Access

XMRig requires Model-Specific Register (MSR) access for optimal RandomX mining performance.

**What MSR access enables:**
- Hardware-level CPU cache optimizations
- Reduced memory latency for RandomX algorithm
- 5-15% hashrate improvement

**Security consideration:** MSR access allows low-level CPU control. Mining user granted this via udev rules and Linux capabilities, not via sudo/root access.

** Component-Specific Rationale

*** SSH Key Separation

Two separate SSH key workflows:

1. **Server access keys** (Phase 2: WireGuard)
   - Authentication for server login (laptop → server)
   - Provisioned during infrastructure setup

2. **Git hosting keys** (Phase 4: Privacy Wrappers)
   - Authentication for git operations (push/pull)
   - Generated after privacy configuration
   - Routed through Tor SOCKS proxy

Keep separate for role-based isolation and to allow rotating keys independently.

*** Trezor Hardware Wallet Limitations

**Critical:** Trezor Suite does NOT support Monero transactions directly.

Trezor supports:
- Device firmware updates
- PIN/passphrase management
- General device management

Monero transactions:
- Use Feather Wallet (installed separately)
- Feather communicates directly with Trezor hardware for signing
- Trezor recovery seed only works with Trezor devices (incompatible with Ledger, software wallets)

Trezor uses SLIP-0010 key derivation (BIP39 seed), incompatible with standard Monero formats (25-word Legacy, 16-word Polyseed, 13-word MyMonero).

For portability: Use standard Monero wallet with Polyseed (16-word) or Legacy (25-word). These work across Feather, Cake Wallet, Monero GUI.

References:
- https://trezor.io/learn/a/monero-xmr
- https://docs.featherwallet.org/guides/hardware-wallet
- https://docs.featherwallet.org/guides/seed-scheme

** Update & Version Management

*** Why Atomic Updates with Rollback

All component updates (monerod, P2Pool, XMRig) use atomic symlink switching:

1. **New version** installed to `/opt/<component>-<version>/`
2. **Current symlink** `/opt/<component>` points to active version
3. **Update** re-points symlink to new version
4. **Failure** rolls back by re-pointing symlink to old version
5. **Instant** switch, no re-download/rebuild on rollback

Old versions kept in `/opt/<component>-<version>/` for quick recovery.

Symlink-based updates provide instant atomic switches with zero-downtime rollback.

** Network Architecture

### P2Pool Network Requirements

P2Pool requires port {{ p2pool_p2p_port }} open (TCP+UDP) for peer communication.

**Mining works without this**, but you won't contribute to pool decentralization.

Forward this port if behind NAT/router for maximum pool participation.

Port varies by type: normal (37889), mini (37888), nano (37890).

### Blockchain Sync on Clearnet

Monerod syncs blockchain via clearnet (not Tor/I2P). **This is intentional.**

Downloading blockchain data doesn't reveal which transactions are yours. Syncing through Tor would:
- Create sybil attack surface
- Significantly slow sync
- Provide no privacy benefit (download ≠ transaction broadcast)

Privacy comes from I2P broadcast (primary) + Tor fallback when *sending* transactions.

Reference: https://github.com/monero-project/monero/blob/master/docs/ANONYMITY_NETWORKS.md

** Monero Port Allocation

Monero services use multiple TCP ports on localhost (127.0.0.1):

| Port  | Service    | Protocol | Purpose                           |
|-------+------------+----------+-----------------------------------|
| 18080 | monerod    | P2P      | Public peer-to-peer network       |
| 18081 | monerod    | HTTP     | Restricted RPC (safe)             |
| 18082 | monerod    | HTTP     | Unrestricted RPC (auto-created)   |
| 18083 | monerod    | ZMQ      | Pub/sub for P2Pool notifications  |
| 18084 | wallet-rpc | HTTP     | Wallet RPC server                 |
| 18085 | monerod    | TCP      | I2P anonymous inbound             |

*** Restricted vs Unrestricted RPC

When monerod is configured with =restricted-rpc=1=, it automatically creates **two RPC endpoints**:

- **Port 18081** (restricted): Safe for untrusted access, limited commands
- **Port 18082** (unrestricted): Full access, dangerous if exposed

Our setup uses only the restricted port (18081). Port 18082 is bound but unused, serving as a safety mechanism - it exists but nothing connects to it.

*** ZMQ Port (18083)

Port 18083 is **NOT an HTTP endpoint**. It's a ZeroMQ pub/sub socket that P2Pool uses to receive block notifications from monerod.

- Shows up in =netstat= as a listening TCP port
- Cannot be accessed via HTTP (curl will fail)
- P2Pool connects using ZMQ protocol, not HTTP

*** Wallet RPC Port (18084)

Standard Monero documentation suggests 18083 for wallet-rpc, but that port is used by ZMQ pub/sub in our configuration. Using 18084 avoids the conflict.

This is why wallet-rpc uses a non-standard port in this setup.

* Appendix H: Troubleshooting & Quick Fixes

** Generic Troubleshooting Patterns

All services follow the same troubleshooting workflow:

*** Check Service Status

#+begin_example
# Is service running?
sudo systemctl status <service>

# What's the status?
sudo systemctl is-active <service>

# Enable on boot
sudo systemctl enable <service>

# Start/stop/restart
sudo systemctl {start|stop|restart} <service>
#+end_example

*** View Service Logs

#+begin_example
# Last 50 lines
sudo journalctl -u <service> -n 50

# Follow in real-time (like tail -f)
sudo journalctl -u <service> -f

# Last hour
sudo journalctl -u <service> --since "1 hour ago"

# Errors only
sudo journalctl -u <service> -p err

# Last boot
sudo journalctl -u <service> -b
#+end_example

*** Reload Configuration After Changes

#+begin_example
# If you edit a service file
sudo systemctl daemon-reload

# If you edit a config file
sudo systemctl restart <service>

# If you edit Ansible, re-tangle and re-run
cd ansible
./tangle-all.sh
./assemble-playbook.sh
ansible-playbook playbook.yml --tags <phase> -K
#+end_example

*** Test Network Connectivity

#+begin_example
# Check internet
ping -c 3 8.8.8.8

# Check DNS
host google.com

# Check specific port
nc -zv <host> <port>

# Check if service is listening
sudo ss -tulpn | grep <port>
#+end_example

** Phase-Specific Quick Fixes

*** Phase 2: WireGuard

**SSH can't connect:**
#+begin_example
# Check WireGuard is running
sudo systemctl status wg-quick@wg0

# Check firewall rules
sudo ufw status | grep 22

# Verify SSH key exists
ls -la ~/.ssh/id_rsa.pub

# Test SSH verbose
ssh -vv <user>@<server>
#+end_example

**WireGuard interface missing:**
#+begin_example
sudo wg-quick up wg0
sudo wg show
#+end_example

***Phase 3: Privacy (Tor, I2P)

**Tor SOCKS proxy not working:**
#+begin_example
# Check Tor running
sudo systemctl status tor

# Test proxy
curl --socks5 127.0.0.1:9050 https://check.torproject.org/api/ip

# Check port listening
sudo ss -tulpn | grep 9050

# Restart
sudo systemctl restart tor
#+end_example

**I2P SAM bridge not responding:**
#+begin_example
# Check I2P running
sudo systemctl status i2pd

# Test SAM bridge
echo -e "HELLO VERSION\n" | nc 127.0.0.1 7656

# Check port listening
sudo ss -tulpn | grep 7656

# Restart
sudo systemctl restart i2pd
#+end_example

**Tor Browser won't start:**
#+begin_example
# Verify installed
ls -la /opt/tor-browser/

# Check permissions
ls -la /usr/local/bin/tor-browser

# Run manually to see errors
/opt/tor-browser/Browser/start-tor-browser
#+end_example

*** Phase 4: Privacy Wrappers (Git, SSH)

**Git operations fail through Tor:**
#+begin_example
# Verify Tor SOCKS proxy working
curl --socks5 127.0.0.1:9050 https://check.torproject.org/api/ip

# Check git config
cat ~/.gitconfig | grep proxy

# Test git connection
GIT_TRACE=1 git clone git@github.com:user/repo.git

# Restart Tor
sudo systemctl restart tor
#+end_example

**SSH to GitHub fails:**
#+begin_example
# Verbose SSH output
ssh -vvv git@github.com

# Check SSH config
cat ~/.ssh/config

# Verify SSH key exists
ls -la ~/.ssh/id_ed25519_github*

# Test netcat proxy
nc -X 5 -x 127.0.0.1:9050 github.com 22

# Restart Tor
sudo systemctl restart tor
#+end_example

*** Phase 5: Monero Full Node

**monerod won't start:**
#+begin_example
# Check logs
sudo journalctl -u monerod -n 100

# Verify config syntax
sudo /opt/monero/monerod --help | head -20

# Check ports
sudo ss -tulpn | grep 18080

# Restart
sudo systemctl restart monerod
#+end_example

**Blockchain sync stuck:**
#+begin_example
# Check current height
sudo monerod-status.sh

# Check peer count
curl http://127.0.0.1:18081/json_rpc \
  -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
  -H 'Content-Type: application/json' | jq '.result | {height, target_height, incoming_connections_count, outgoing_connections_count}'

# Check bandwidth limits aren't too low
grep "limit-rate" /etc/monerod.conf

# Restart with verbose logging
sudo systemctl stop monerod
sudo /opt/monero/monerod --config-file /etc/monerod.conf --log-level 2
#+end_example

**RPC not responding:**
#+begin_example
# Check service running
sudo systemctl status monerod

# Check port listening
sudo ss -tulpn | grep 18081

# Test RPC directly
curl http://127.0.0.1:18081/json_rpc \
  -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
  -H 'Content-Type: application/json'

# Wait for sync to progress
sudo monerod-status.sh
#+end_example

**ZMQ port not listening (breaks P2Pool):**
#+begin_example
# Check if ZMQ configured
grep zmq-pub /etc/monerod.conf

# Check port listening
sudo ss -tulpn | grep 18083

# Verify in config
sudo systemctl cat monerod | grep zmq

# Restart monerod
sudo systemctl restart monerod

# Wait and check again
sleep 10
sudo ss -tulpn | grep 18083
#+end_example

*** Phase 7: Mining (P2Pool, XMRig)

**P2Pool won't start:**
#+begin_example
# Check monerod is running and synced
sudo monerod-status.sh

# Check P2Pool logs
sudo journalctl -u p2pool -n 100

# Verify config
sudo systemctl cat p2pool | grep ExecStart

# Restart
sudo systemctl restart p2pool
#+end_example

**XMRig shows no hashrate:**
#+begin_example
# Check XMRig running
sudo systemctl status xmrig

# Check logs for errors
sudo journalctl -u xmrig -n 50

# Verify wallet address configured
grep wallet /opt/xmrig/build/config.json

# Check P2Pool is responding
sudo systemctl status p2pool

# Restart both
sudo systemctl restart p2pool
sudo systemctl restart xmrig
#+end_example

**Mining not starting after monerod sync:**
#+begin_example
# Verify monerod fully synced
sudo monerod-status.sh
# Should show: "✓ Blockchain synced"

# Wait 60 seconds for P2Pool to detect sync
sleep 60

# Restart mining services
sudo systemctl restart p2pool
sudo systemctl restart xmrig

# Monitor
sudo journalctl -u xmrig -f
#+end_example

*** Phase 8: Firewall

**Locked out of SSH:**
#+begin_example
# Physical console access (emergency only)
# Connect keyboard/monitor to server

# Check firewall status
sudo ufw status

# Allow SSH (if locked out somehow)
sudo ufw allow 22/tcp

# Reset firewall (DANGEROUS - opens everything)
sudo ufw --force reset
#+end_example

**Port not accessible from outside:**
#+begin_example
# Check firewall allows port
sudo ufw status | grep <port>

# Check service listening
sudo ss -tulpn | grep <port>

# If behind NAT/router, check port forward
# (requires router admin access)

# Test from remote machine
nc -zv <server-ip> <port>
#+end_example

** Common Error Messages

| Error | Cause | Fix |
|-------|-------|-----|
| "Connection refused" | Service not running | `sudo systemctl start <service>` |
| "Address already in use" | Port conflict | Find what's using port: `sudo ss -tulpn \| grep <port>` |
| "Permission denied" | Running as wrong user | Use `sudo` or `su -` to correct user |
| "Config error" | Syntax error in config | Check logs: `sudo journalctl -u <service> -n 20` |
| "Can't connect to X" | Network/firewall issue | Test connectivity: `ping`, `nc -zv` |
| "Out of memory" | System under-resourced | Check: `free -h`, `top` |
| "Disk full" | Storage exhausted | Check: `df -h`, remove old logs/backups |

** When All Else Fails

**1. Check the logs (always start here):**
#+begin_example
sudo journalctl -u <service> -n 100
#+end_example

**2. Restart the service:**
#+begin_example
sudo systemctl restart <service>
#+end_example

**3. Check system resources:**
#+begin_example
free -h              # Memory
df -h /              # Disk
top -b -n 1          # CPU
#+end_example

**4. Review official documentation:**
- Monero: https://monerodocs.org
- Tor: https://support.torproject.org
- P2Pool: https://github.com/SChernykh/p2pool
- Ansible: https://docs.ansible.com

**5. Restore from backup:**
#+begin_example
sudo restore.sh /srv/backups/backup_<date>.tar.gz
#+end_example

**6. Rollback a recent change:**
#+begin_example
git log --oneline
git checkout <previous-commit> -- org/
cd ansible && ./tangle-all.sh && ./assemble-playbook.sh
ansible-playbook playbook.yml --tags <phase>
#+end_example

** Reporting Issues

When asking for help, always include:
1. **Service logs:** `sudo journalctl -u <service> -n 100`
2. **System status:** `free -h && df -h && systemctl status`
3. **What you did:** "Ran phase X, then Y failed"
4. **Error message:** Exact text from logs or screen
5. **Your configuration:** Relevant parts of `config.yml`

Example issue report:
#+begin_example
monerod won't sync past height 2,800,000.

Service status: running
Logs: journalctl -u monerod shows "SYNCHRONIZATION FAILED"
Connections: 2 incoming, 5 outgoing
Bandwidth limits: 8192 KB/s down, 2048 KB/s up

What I did: Installed Phase 5 yesterday, it synced fine for 24 hours,
then stopped progressing.

Config: default monerod settings from config.yml.example
#+end_example

** Appendix I: Secure Git Credential Management with KeePassXC

*** Overview

This appendix documents the working configuration for Git operations using KeePassXC for credential storage.

**Security model:**
- GitHub PAT stored encrypted in KeePassXC (never plaintext on disk)
- git-credential-keepassxc handles credential retrieval from KeePassXC database
- Master password protects all credentials (unlocked once per session)

**Prerequisites:**
- KeePassXC installed (Phase 3)
- git-credential-keepassxc from AUR (manual install, see Phase 3 notes)

*** Initial Configuration

These commands configure git-credential-keepassxc with the correct caller permissions:

#+begin_src bash
# Temporarily move existing config (if any)
mv ~/.config/git-credential-keepassxc ~/.config/git-credential-keepassxc.bak 2>/dev/null || true

# Allow actual callers (git and bash processes)
git-credential-keepassxc caller add --uid "$(id -u)" --gid "$(id -g)" "$(command -v bash)"
git-credential-keepassxc caller add --uid "$(id -u)" --gid "$(id -g)" "$(command -v git)"

# Note: git-remote-https path must be added manually (see below)
#+end_src

**Manual step:** Edit =~/.config/git-credential-keepassxc= and add git-remote-https to allowed-callers:

#+begin_src json
{
  "allowed-callers": [
    {
      "path": "/usr/lib/git-core/git-remote-https",
      "uid": YOUR_UID,
      "gid": YOUR_GID,
      "canonicalize": false
    },
    ... other entries ...
  ]
}
#+end_src

Replace =YOUR_UID= and =YOUR_GID= with output from =id -u= and =id -g=.

Find exact path if needed: =find /usr/lib/git-core -name 'git-remote-https*'=

*** Pair with KeePassXC

#+begin_src bash
# Database must be unlocked in KeePassXC GUI
git-credential-keepassxc configure
#+end_src

Approve the connection request in KeePassXC popup.

This creates a "Git" group under "Root" in your KeePassXC database.

*** Configure Git

#+begin_src bash
# Use KeePassXC credential helper with git-groups flag
git config --global credential.helper 'keepassxc --git-groups'
#+end_src

**About --git-groups flag:**
- Tells git-credential-keepassxc to only search entries in groups named "Git"
- Without this flag, it searches all groups and may find multiple matches
- Multiple matches require manual selection each time
- KeePassXC automatically created a "Git" group under "Root" during initial configuration

*** KeePassXC Entry Setup

Create entry in KeePassXC GUI:

| Field    | Value                                    |
|----------+------------------------------------------|
| Group    | Git (must be named exactly "Git")        |
| Title    | GitHub PAT                               |
| Username | *Your GitHub username* (required, not blank) |
| Password | *Your GitHub Personal Access Token*      |
| URL      | https://github.com                       |

**Group structure:**
#+begin_example
Root
├── Git (created by git-credential-keepassxc configure)
│   └── GitHub PAT (credential entry - PAT token)
└── (other groups with GitHub login credentials, browser logins, etc.)
#+end_example

**Why separate groups:**
- "Git" group: PAT for git operations
- Other groups: Browser login credentials, account passwords
- --git-groups flag ensures git only finds the PAT, not your account password

**PAT requirements:**
- Type: Classic token (not fine-grained)
- Scope: =repo= (for private repos) or =public_repo= (for public only)
- Expiration: Set appropriately for your security needs

*** Verification

Test credential retrieval:

#+begin_src bash
# Basic test (should return username + PAT)
printf "protocol=https\nhost=github.com\n" | git credential fill

# Full test (simulates actual git operation)
printf "protocol=https\nhost=github.com\npath=yourusername/yourrepo.git\n" | git credential fill
#+end_src

Expected output:
#+begin_example
protocol=https
host=github.com
username=yourusername
password=ghp_YourPATHere...
#+end_example

*** Daily Usage

Git operations work normally - KeePassXC provides credentials transparently:

#+begin_src bash
git fetch
git pull
git push
#+end_src

**First operation:**
- KeePassXC popup may ask to approve credential access
- Select "Allow" or "Allow always" (for this session)
- Database remains unlocked until KeePassXC closes

*** Troubleshooting

**Common issues:**

*Authentication failures:*
- Verify username in KeePassXC entry matches GitHub username exactly
- Blank username will cause auth failures
- PAT must have correct scope (repo/public_repo)

*"KeePassXC doesn't allow erasing logins" warning:*
- Cosmetic issue, does not affect functionality
- Safe to ignore

*Credential not found:*
- Check KeePassXC database is unlocked
- Verify git-credential-keepassxc pairing: =git-credential-keepassxc configure=
- Confirm URL in KeePassXC entry is exactly: =https://github.com=
- Ensure entry is in "Git" group (not another group)

*Multiple credential matches:*
- Verify =--git-groups= flag in credential.helper config
- Check you don't have duplicate entries in "Git" group
- Move other GitHub credentials to different groups

*Caller verification errors:*
- Manually verify =~/.config/git-credential-keepassxc= has correct UIDs/GIDs
- Path to git-remote-https must be exact (use =find= command above)
- Note: =git-credential-keepassxc caller list= may not work (inspect config file directly)

**Debug workflow:**
#+begin_src bash
# 1. Check git config
git config --global --list | grep credential

# 2. Test credential helper directly
printf "protocol=https\nhost=github.com\n" | git credential fill

# 3. Check KeePassXC database
# Open KeePassXC GUI, verify entry exists in Git group

# 4. Verify --git-groups flag
git config --global credential.helper
# Should show: keepassxc --git-groups
#+end_src

*** Security Notes

**Why this approach:**
- PAT never stored in plaintext on disk (only in encrypted KeePassXC database)
- Master password required to unlock credentials
- git-credential-keepassxc provides secure communication with KeePassXC
- Separate "Git" group isolates git credentials from browser/account passwords

**Trade-offs:**
- Requires KeePassXC unlocked during git operations
- Initial setup more complex than plaintext credentials
- git-credential-keepassxc from AUR (not official repos)

**Alternative approaches not used:**
- Plain text =~/.netrc=: Credentials visible on disk
- Git credential.helper store: Plaintext file
- SSH keys for GitHub: Requires separate key management, doesn't work with HTTPS remotes

*** References

- git-credential-keepassxc: https://github.com/Frederick888/git-credential-keepassxc
- GitHub PAT docs: https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens
- KeePassXC Browser Integration: https://keepassxc.org/docs/KeePassXC_GettingStarted.html#_setup_browser_integration

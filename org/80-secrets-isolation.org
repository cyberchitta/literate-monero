** Overview

This phase isolates sensitive credentials from sandboxed applications by consolidating secrets into a hidden directory.

**What gets isolated:**
- SSH keys (both server access and git hosting)
- GPG keys
- Monero wallets (CLI and Feather)

**Not isolated (already encrypted):**
- KeePassXC databases (`.kdbx` files in Documents - encrypted with master password)

**How it works:**
1. Create `.secrets/` directory structure
2. Move existing secrets from traditional locations
3. Create symlinks from original locations → `.secrets/`
4. Sandboxed apps (Phase 14) see broken symlinks (targets hidden by tmpfs)

**Prerequisites:** Phases 11-18 must have created secrets (SSH keys, wallets, etc.)

** Create Secrets Directory Structure

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    # ------------------------------------------------------------------------
    # Secrets Isolation (Finalization)
    # ------------------------------------------------------------------------

    - name: Create .secrets directory structure
      file:
        path: "/home/{{ dev_user }}/.secrets/{{ item }}"
        state: directory
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0700'
      loop:
        - ssh
        - gnupg
        - wallets/bitmonero
        - wallets/feather
      tags: [secrets-isolation]
#+end_src

** Migrate SSH Keys

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Check if SSH directory exists
      stat:
        path: "/home/{{ dev_user }}/.ssh"
      register: ssh_dir
      tags: [secrets-isolation]

    - name: Move SSH keys to .secrets (if not already a symlink)
      shell: |
        if [ ! -L "/home/{{ dev_user }}/.ssh" ]; then
          mv "/home/{{ dev_user }}/.ssh" "/home/{{ dev_user }}/.secrets/ssh.tmp"
          rsync -a "/home/{{ dev_user }}/.secrets/ssh.tmp/" "/home/{{ dev_user }}/.secrets/ssh/"
          rm -rf "/home/{{ dev_user }}/.secrets/ssh.tmp"
        fi
      become: yes
      become_user: "{{ dev_user }}"
      when: ssh_dir.stat.exists and not ssh_dir.stat.islnk
      tags: [secrets-isolation]

    - name: Create SSH symlink
      file:
        src: "/home/{{ dev_user }}/.secrets/ssh"
        dest: "/home/{{ dev_user }}/.ssh"
        state: link
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        force: yes
      tags: [secrets-isolation]
#+end_src

** Migrate GPG Keys

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Check if GPG directory exists
      stat:
        path: "/home/{{ dev_user }}/.gnupg"
      register: gnupg_dir
      tags: [secrets-isolation]

    - name: Move GPG keys to .secrets (if not already a symlink)
      shell: |
        if [ ! -L "/home/{{ dev_user }}/.gnupg" ]; then
          mv "/home/{{ dev_user }}/.gnupg" "/home/{{ dev_user }}/.secrets/gnupg.tmp"
          rsync -a "/home/{{ dev_user }}/.secrets/gnupg.tmp/" "/home/{{ dev_user }}/.secrets/gnupg/"
          rm -rf "/home/{{ dev_user }}/.secrets/gnupg.tmp"
        fi
      become: yes
      become_user: "{{ dev_user }}"
      when: gnupg_dir.stat.exists and not gnupg_dir.stat.islnk
      tags: [secrets-isolation]

    - name: Create GPG symlink
      file:
        src: "/home/{{ dev_user }}/.secrets/gnupg"
        dest: "/home/{{ dev_user }}/.gnupg"
        state: link
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        force: yes
      tags: [secrets-isolation]
#+end_src

** Migrate Monero Wallets

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Check if .bitmonero exists
      stat:
        path: "/home/{{ dev_user }}/.bitmonero"
      register: bitmonero_dir
      tags: [secrets-isolation]

    - name: Move .bitmonero to .secrets (if not already a symlink)
      shell: |
        if [ ! -L "/home/{{ dev_user }}/.bitmonero" ]; then
          mv "/home/{{ dev_user }}/.bitmonero" "/home/{{ dev_user }}/.secrets/wallets/bitmonero.tmp"
          rsync -a "/home/{{ dev_user }}/.secrets/wallets/bitmonero.tmp/" "/home/{{ dev_user }}/.secrets/wallets/bitmonero/"
          rm -rf "/home/{{ dev_user }}/.secrets/wallets/bitmonero.tmp"
        fi
      become: yes
      become_user: "{{ dev_user }}"
      when: bitmonero_dir.stat.exists and not bitmonero_dir.stat.islnk
      tags: [secrets-isolation]

    - name: Create .bitmonero symlink
      file:
        src: "/home/{{ dev_user }}/.secrets/wallets/bitmonero"
        dest: "/home/{{ dev_user }}/.bitmonero"
        state: link
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        force: yes
      tags: [secrets-isolation]

    - name: Check if Monero/wallets exists
      stat:
        path: "/home/{{ dev_user }}/Monero/wallets"
      register: feather_wallets_dir
      tags: [secrets-isolation]

    - name: Move Feather wallets to .secrets (if not already a symlink)
      shell: |
        if [ ! -L "/home/{{ dev_user }}/Monero/wallets" ]; then
          mkdir -p "/home/{{ dev_user }}/Monero"
          mv "/home/{{ dev_user }}/Monero/wallets" "/home/{{ dev_user }}/.secrets/wallets/feather.tmp"
          rsync -a "/home/{{ dev_user }}/.secrets/wallets/feather.tmp/" "/home/{{ dev_user }}/.secrets/wallets/feather/"
          rm -rf "/home/{{ dev_user }}/.secrets/wallets/feather.tmp"
        fi
      become: yes
      become_user: "{{ dev_user }}"
      when: feather_wallets_dir.stat.exists and not feather_wallets_dir.stat.islnk
      tags: [secrets-isolation]

    - name: Create Feather wallets symlink
      file:
        src: "/home/{{ dev_user }}/.secrets/wallets/feather"
        dest: "/home/{{ dev_user }}/Monero/wallets"
        state: link
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        force: yes
      tags: [secrets-isolation]
#+end_src

** Verify Secrets Isolation

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Verify .secrets directory exists
      stat:
        path: "/home/{{ dev_user }}/.secrets"
      register: secrets_dir
      tags: [secrets-isolation, verify]

    - name: Verify symlinks created
      stat:
        path: "/home/{{ dev_user }}/{{ item }}"
      register: symlink_check
      loop:
        - .ssh
        - .gnupg
        - .bitmonero
        - Monero/wallets
      tags: [secrets-isolation, verify]

    - name: Test sandbox isolation
      shell: |
        # Test that .secrets is hidden in sandbox
        if bwrap --ro-bind / / --tmpfs /home/{{ dev_user }}/.secrets ls /home/{{ dev_user }}/.secrets 2>&1 | grep -q "No such file"; then
          echo "isolated"
        else
          echo "not_isolated"
        fi
      register: sandbox_test
      changed_when: false
      become: yes
      become_user: "{{ dev_user }}"
      tags: [secrets-isolation, verify]

    - name: Display secrets isolation status
      debug:
        msg:
          - "=== Secrets Isolation Complete ==="
          - ""
          - ".secrets directory: {% if secrets_dir.stat.exists %}Created{% else %}Not found{% endif %}"
          - ""
          - "Symlinks created:"
          - "  ~/.ssh → ~/.secrets/ssh"
          - "  ~/.gnupg → ~/.secrets/gnupg"
          - "  ~/.bitmonero → ~/.secrets/wallets/bitmonero"
          - "  ~/Monero/wallets → ~/.secrets/wallets/feather"
          - ""
          - "Not isolated (already encrypted):"
          - "  ~/Documents/*.kdbx (KeePassXC databases)"
          - ""
          - "Sandbox isolation: {% if sandbox_test.stdout == 'isolated' %}Working{% else %}Failed{% endif %}"
          - ""
          - "Test isolation:"
          - "  # Normal shell - sees secrets"
          - "  ls -la ~/.ssh"
          - ""
          - "  # Sandboxed - sees nothing"
          - "  bwrap --ro-bind / / --tmpfs ~/.secrets ls -la ~/.ssh"
          - ""
          - "Claude Code automatically sandboxed via 'claude-code' alias"
          - ""
      tags: [secrets-isolation, verify]
#+end_src

** Notes

*** Directory Structure

After migration:
```
/home/dev/.secrets/           (mode 0700, hidden from sandboxed apps)
├── ssh/                      (SSH keys for server + git)
├── gnupg/                    (GPG keys)
└── wallets/
    ├── bitmonero/            (CLI wallet data)
    └── feather/              (Feather wallet data)

# Symlinks (appear broken in sandbox)
/home/dev/.ssh → /home/dev/.secrets/ssh
/home/dev/.gnupg → /home/dev/.secrets/gnupg
/home/dev/.bitmonero → /home/dev/.secrets/wallets/bitmonero
/home/dev/Monero/wallets → /home/dev/.secrets/wallets/feather

# Not isolated (encrypted blobs)
/home/dev/Documents/*.kdbx    (KeePassXC databases)
```

*** Why KeePassXC Databases Aren't Isolated

KeePassXC `.kdbx` files are:
- Already encrypted with master password
- Safe to expose to AI agents (encrypted blobs)
- Backed up normally in Documents directory

Only plaintext secrets (SSH keys, GPG keys) need isolation.

*** Migration Strategy

The migration is **idempotent** - safe to re-run:
1. Check if target is already a symlink (skip if yes)
2. Move directory to temporary location in `.secrets/`
3. Copy contents to final location
4. Remove temporary directory
5. Create symlink

This prevents data loss if phase is run multiple times.

*** Testing Isolation

From normal shell (secrets visible):
```bash
ls -la ~/.ssh        # Shows keys
cat ~/.ssh/id_rsa    # Shows private key
```

From sandboxed context (secrets hidden):
```bash
bwrap --ro-bind / / --tmpfs ~/.secrets ls -la ~/.ssh
# Error: No such file or directory

claude-code-sandboxed
# Claude Code cannot access SSH keys, GPG, wallets
```

** Overview

This phase isolates sensitive credentials from sandboxed applications by consolidating secrets into a hidden directory.

**What gets isolated:**
- SSH keys (both server access and git hosting)
- GPG keys
- Monero wallets (CLI and Feather)

**Not isolated (already encrypted):**
- KeePassXC databases (`.kdbx` files in Documents - encrypted with master password)

**How it works:**
1. Create `.secrets/` directory structure
2. Move existing secrets from traditional locations
3. Create symlinks from original locations → `.secrets/`
4. Sandboxed apps (Phase 14) see broken symlinks (targets hidden by tmpfs)

**Prerequisites:** Phases 11-18 must have created secrets (SSH keys, wallets, etc.)

** Create Secrets Directory Structure

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    # ------------------------------------------------------------------------
    # Secrets Isolation (Finalization)
    # ------------------------------------------------------------------------

    - name: Create .secrets directory structure
      file:
        path: "/home/{{ dev_user }}/.secrets/{{ item }}"
        state: directory
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0700'
      loop:
        - ssh
        - gnupg
        - wallets/bitmonero
        - wallets/feather
      tags: [secrets-isolation]
#+end_src

** Migrate Secrets

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Migrate secrets to .secrets and create symlinks
      block:
        - name: Define secrets to migrate
          set_fact:
            secrets_to_migrate:
              - { src: "/home/{{ dev_user }}/.ssh", dest: "/home/{{ dev_user }}/.secrets/ssh" }
              - { src: "/home/{{ dev_user }}/.gnupg", dest: "/home/{{ dev_user }}/.secrets/gnupg" }
              - { src: "/home/{{ dev_user }}/.bitmonero", dest: "/home/{{ dev_user }}/.secrets/wallets/bitmonero" }
              - { src: "/home/{{ dev_user }}/Monero/wallets", dest: "/home/{{ dev_user }}/.secrets/wallets/feather" }

        - name: Ensure parent directories exist
          file:
            path: "/home/{{ dev_user }}/Monero"
            state: directory
            owner: "{{ dev_user }}"
            group: "{{ dev_user }}"
            mode: '0755'
          tags: [secrets-isolation]

        - name: Migrate and symlink secrets
          shell: |
            SRC="{{ item.src }}"
            DEST="{{ item.dest }}"

            # If already a symlink pointing to the right place, skip
            if [ -L "$SRC" ] && [ "$(readlink -f "$SRC")" = "$DEST" ]; then
            exit 0
            fi

            # If source exists and is not a symlink, migrate it
            if [ -e "$SRC" ] && [ ! -L "$SRC" ]; then
            # Ensure destination parent exists
            mkdir -p "$(dirname "$DEST")"

            # Move source to destination
            mv "$SRC" "$DEST"

            # Create symlink from original location to new location
            ln -s "$DEST" "$SRC"
            fi
          become: yes
          become_user: "{{ dev_user }}"
          register: secret_migration
          failed_when: secret_migration.rc != 0
          loop: "{{ secrets_to_migrate }}"
          tags: [secrets-isolation]
      tags: [secrets-isolation]
#+end_src

** Verify Secrets Isolation

#+begin_src yaml :tangle ../ansible/fragments/80-secrets-isolation.yml
    - name: Verify .secrets directory exists
      stat:
        path: "/home/{{ dev_user }}/.secrets"
      register: secrets_dir
      tags: [secrets-isolation, verify]

    - name: Verify symlinks created
      stat:
        path: "/home/{{ dev_user }}/{{ item }}"
      register: symlink_check
      loop:
        - .ssh
        - .gnupg
        - .bitmonero
        - Monero/wallets
      tags: [secrets-isolation, verify]

    - name: Test sandbox isolation
      shell: |
        # Test that .secrets is hidden in sandbox
        if bwrap --ro-bind / / --tmpfs /home/{{ dev_user }}/.secrets test -f /home/{{ dev_user }}/.ssh/config 2>&1; then
          echo "not_isolated"
        else
          echo "isolated"
        fi
      register: sandbox_test
      changed_when: false
      become: yes
      become_user: "{{ dev_user }}"
      tags: [secrets-isolation, verify]

    - name: Display secrets isolation status
      debug:
        msg:
          - "=== Secrets Isolation Complete ==="
          - ""
          - ".secrets directory: {% if secrets_dir.stat.exists %}Created{% else %}Not found{% endif %}"
          - ""
          - "Symlinks created:"
          - "  ~/.ssh → ~/.secrets/ssh"
          - "  ~/.gnupg → ~/.secrets/gnupg"
          - "  ~/.bitmonero → ~/.secrets/wallets/bitmonero"
          - "  ~/Monero/wallets → ~/.secrets/wallets/feather"
          - ""
          - "Not isolated (already encrypted):"
          - "  ~/Documents/*.kdbx (KeePassXC databases)"
          - ""
          - "Sandbox isolation: {% if sandbox_test.stdout == 'isolated' %}Working{% else %}Failed{% endif %}"
          - ""
          - "Test isolation:"
          - "  # Normal shell - sees secrets"
          - "  ls -la ~/.ssh"
          - ""
          - "  # Sandboxed - sees nothing"
          - "  bwrap --ro-bind / / --tmpfs ~/.secrets ls -la ~/.ssh"
          - ""
          - "Claude Code automatically sandboxed via 'claude-code' alias"
          - ""
      tags: [secrets-isolation, verify]
#+end_src

** Notes

*** Directory Structure

After migration:
```
/home/dev/.secrets/           (mode 0700, hidden from sandboxed apps)
├── ssh/                      (SSH keys for server + git)
├── gnupg/                    (GPG keys)
└── wallets/
    ├── bitmonero/            (CLI wallet data)
    └── feather/              (Feather wallet data)

# Symlinks (appear broken in sandbox)
/home/dev/.ssh → /home/dev/.secrets/ssh
/home/dev/.gnupg → /home/dev/.secrets/gnupg
/home/dev/.bitmonero → /home/dev/.secrets/wallets/bitmonero
/home/dev/Monero/wallets → /home/dev/.secrets/wallets/feather

# Not isolated (encrypted blobs)
/home/dev/Documents/*.kdbx    (KeePassXC databases)
```

*** Why KeePassXC Databases Aren't Isolated

KeePassXC `.kdbx` files are:
- Already encrypted with master password
- Safe to expose to AI agents (encrypted blobs)
- Backed up normally in Documents directory

Only plaintext secrets (SSH keys, GPG keys) need isolation.

*** Migration Strategy

The migration is **idempotent** - safe to re-run:
1. Check if target is already a symlink (skip if yes)
2. Move directory to temporary location in `.secrets/`
3. Copy contents to final location
4. Remove temporary directory
5. Create symlink

This prevents data loss if phase is run multiple times.

*** Testing Isolation

From normal shell (secrets visible):
```bash
ls -la ~/.ssh        # Shows keys
cat ~/.ssh/id_rsa    # Shows private key
```

From sandboxed context (secrets hidden):
```bash
bwrap --ro-bind / / --tmpfs ~/.secrets ls -la ~/.ssh
# Error: No such file or directory

claude-code-sandboxed
# Claude Code cannot access SSH keys, GPG, wallets
```

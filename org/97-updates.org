** Overview

This phase provides update management for installed software components:
- Version discovery (check for updates)
- Safe component updates with verification
- Rollback to previous versions
- Optional automated update checking

All updates are atomic (symlink switches) with automatic rollback on failure.

** Check for Available Updates Script

#+begin_src bash :tangle ../configs/templates/check-updates.sh.j2
#!/bin/bash
# Check for available software updates
# Queries GitHub releases and compares with config.yml versions

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="{{ lookup('env', 'HOME') }}/literate-monero/config.yml"

# Function to extract version from config.yml
get_current_version() {
    local component="$1"
    grep "^${component}_version:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"'
}

# Function to get latest GitHub release
get_latest_release() {
    local repo="$1"
    local current_version="$2"

    # Query GitHub API (no auth needed for public repos)
    local release_info
    release_info=$(curl -s "https://api.github.com/repos/${repo}/releases/latest")

    if echo "$release_info" | grep -q '"tag_name"'; then
        local latest_version
        latest_version=$(echo "$release_info" | grep '"tag_name"' | head -1 | cut -d'"' -f4)

        local release_url
        release_url=$(echo "$release_info" | grep '"html_url"' | head -1 | cut -d'"' -f4)

        # Normalize versions for comparison (remove 'v' prefix)
        local current_norm="${current_version#v}"
        local latest_norm="${latest_version#v}"

        if [ "$current_norm" = "$latest_norm" ]; then
            echo "up-to-date|$latest_version|$release_url"
        else
            echo "available|$latest_version|$release_url"
        fi
    else
        echo "error|unknown|"
    fi
}

echo -e "${BLUE}=== Checking for Software Updates ===${NC}"
echo "Current configuration: $CONFIG_FILE"
echo ""

# Check Monerod
echo -e "${YELLOW}Checking Monerod...${NC}"
MONEROD_CURRENT=$(get_current_version "monerod")
MONEROD_CHECK=$(get_latest_release "monero-project/monero" "$MONEROD_CURRENT")
IFS='|' read -r MONEROD_STATUS MONEROD_LATEST MONEROD_URL <<< "$MONEROD_CHECK"

# Check P2Pool
echo -e "${YELLOW}Checking P2Pool...${NC}"
P2POOL_CURRENT=$(get_current_version "p2pool")
P2POOL_CHECK=$(get_latest_release "SChernykh/p2pool" "$P2POOL_CURRENT")
IFS='|' read -r P2POOL_STATUS P2POOL_LATEST P2POOL_URL <<< "$P2POOL_CHECK"

# Check XMRig
echo -e "${YELLOW}Checking XMRig...${NC}"
XMRIG_CURRENT=$(get_current_version "xmrig")
XMRIG_CHECK=$(get_latest_release "xmrig/xmrig" "$XMRIG_CURRENT")
IFS='|' read -r XMRIG_STATUS XMRIG_LATEST XMRIG_URL <<< "$XMRIG_CHECK"

echo ""
echo -e "${BLUE}=== Update Summary ===${NC}"
echo ""
printf "%-15s %-20s %-20s %-10s\n" "Component" "Current" "Latest" "Status"
printf "%-15s %-20s %-20s %-10s\n" "─────────" "───────" "──────" "──────"

# Monerod
if [ "$MONEROD_STATUS" = "available" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${YELLOW}%-10s${NC}\n" "Monerod" "$MONEROD_CURRENT" "$MONEROD_LATEST" "UPDATE"
    echo "  Release: $MONEROD_URL"
elif [ "$MONEROD_STATUS" = "up-to-date" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${GREEN}%-10s${NC}\n" "Monerod" "$MONEROD_CURRENT" "$MONEROD_LATEST" "CURRENT"
else
    printf "%-15s %-20s ${RED}%-20s${NC} ${RED}%-10s${NC}\n" "Monerod" "$MONEROD_CURRENT" "unknown" "ERROR"
fi

# P2Pool
if [ "$P2POOL_STATUS" = "available" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${YELLOW}%-10s${NC}\n" "P2Pool" "$P2POOL_CURRENT" "$P2POOL_LATEST" "UPDATE"
    echo "  Release: $P2POOL_URL"
elif [ "$P2POOL_STATUS" = "up-to-date" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${GREEN}%-10s${NC}\n" "P2Pool" "$P2POOL_CURRENT" "$P2POOL_LATEST" "CURRENT"
else
    printf "%-15s %-20s ${RED}%-20s${NC} ${RED}%-10s${NC}\n" "P2Pool" "$P2POOL_CURRENT" "unknown" "ERROR"
fi

# XMRig
if [ "$XMRIG_STATUS" = "available" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${YELLOW}%-10s${NC}\n" "XMRig" "$XMRIG_CURRENT" "$XMRIG_LATEST" "UPDATE"
    echo "  Release: $XMRIG_URL"
elif [ "$XMRIG_STATUS" = "up-to-date" ]; then
    printf "%-15s %-20s ${GREEN}%-20s${NC} ${GREEN}%-10s${NC}\n" "XMRig" "$XMRIG_CURRENT" "$XMRIG_LATEST" "CURRENT"
else
    printf "%-15s %-20s ${RED}%-20s${NC} ${RED}%-10s${NC}\n" "XMRig" "$XMRIG_CURRENT" "unknown" "ERROR"
fi

echo ""
echo -e "${BLUE}=== Update Instructions ===${NC}"
echo "To update a component:"
echo "  sudo update-monerod.sh   # Update Monerod"
echo "  sudo update-p2pool.sh    # Update P2Pool"
echo "  sudo update-xmrig.sh     # Update XMRig"
echo ""
echo "To rollback after update:"
echo "  sudo rollback-monerod.sh  # Rollback Monerod"
echo "  sudo rollback-p2pool.sh   # Rollback P2Pool"
echo "  sudo rollback-xmrig.sh    # Rollback XMRig"
echo ""
#+end_src

** Update Monerod Script

#+begin_src bash :tangle ../configs/templates/update-monerod.sh.j2
#!/bin/bash
# Update monerod to latest version
# Safe atomic update with automatic rollback on failure

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="{{ lookup('env', 'HOME') }}/literate-monero/config.yml"
BACKUP_CONFIG="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

# Get current version
CURRENT_VERSION=$(grep "^monerod_version:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')

# Get latest version from GitHub
echo -e "${BLUE}Checking for latest monerod release...${NC}"
RELEASE_INFO=$(curl -s "https://api.github.com/repos/monero-project/monero/releases/latest")
LATEST_VERSION=$(echo "$RELEASE_INFO" | grep '"tag_name"' | head -1 | cut -d'"' -f4)

if [ -z "$LATEST_VERSION" ]; then
    echo -e "${RED}Error: Could not determine latest version${NC}"
    exit 1
fi

# Compare versions
CURRENT_NORM="${CURRENT_VERSION#v}"
LATEST_NORM="${LATEST_VERSION#v}"

if [ "$CURRENT_NORM" = "$LATEST_NORM" ]; then
    echo -e "${GREEN}Already up to date: $CURRENT_VERSION${NC}"
    exit 0
fi

echo ""
echo -e "${YELLOW}Update Available:${NC}"
echo "  Current: $CURRENT_VERSION"
echo "  Latest:  $LATEST_VERSION"
echo ""
read -p "Proceed with update? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

echo ""
echo -e "${BLUE}=== Starting Monerod Update ===${NC}"

# Backup current config
echo "Backing up config.yml..."
cp "$CONFIG_FILE" "$BACKUP_CONFIG"

# Update version in config.yml
echo "Updating config.yml to $LATEST_VERSION..."
sed -i "s/^monerod_version:.*/monerod_version: \"$LATEST_VERSION\"/" "$CONFIG_FILE"

# Re-tangle org files
echo "Re-tangling org files..."
cd "{{ lookup('env', 'HOME') }}/literate-monero"
./tangle.sh > /dev/null 2>&1

# Run Ansible to install new version
echo "Running Ansible playbook..."
cd ansible
if ansible-playbook playbook.yml --tags monerod -v; then
    echo -e "${GREEN}✓ Ansible playbook completed successfully${NC}"
else
    echo -e "${RED}✗ Ansible playbook failed${NC}"
    echo "Rolling back to $CURRENT_VERSION..."
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"
    exit 1
fi

# Wait for service to start
echo "Waiting for monerod to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet monerod; then
    echo -e "${GREEN}✓ Monerod service is running${NC}"
else
    echo -e "${RED}✗ Monerod service failed to start${NC}"
    echo "Rolling back to $CURRENT_VERSION..."

    # Restore config
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"

    # Repoint symlink to old version
    rm -f /opt/monero
    ln -s "/opt/monero-${CURRENT_VERSION}" /opt/monero

    # Restart service
    systemctl restart monerod

    exit 1
fi

# Test RPC connectivity
echo "Testing RPC connectivity..."
if curl -s --max-time 10 "http://127.0.0.1:{{ monerod_rpc_port }}/json_rpc" \
    -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
    -H 'Content-Type: application/json' | grep -q '"status":"OK"'; then
    echo -e "${GREEN}✓ RPC responding correctly${NC}"
else
    echo -e "${RED}✗ RPC not responding${NC}"
    echo "Rolling back to $CURRENT_VERSION..."

    # Restore config
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"

    # Repoint symlink to old version
    rm -f /opt/monero
    ln -s "/opt/monero-${CURRENT_VERSION}" /opt/monero

    # Restart service
    systemctl restart monerod

    exit 1
fi

echo ""
echo -e "${GREEN}=== Monerod Update Complete ===${NC}"
echo "  Updated: $CURRENT_VERSION → $LATEST_VERSION"
echo "  Old version kept at: /opt/monero-${CURRENT_VERSION}"
echo "  Current version at: /opt/monero → /opt/monero-${LATEST_VERSION}"
echo ""
echo "Monitor status:"
echo "  sudo monerod-status.sh"
echo "  sudo journalctl -u monerod -f"
echo ""
echo "Rollback if needed:"
echo "  sudo rollback-monerod.sh"
echo ""

# Clean up backup config after successful update
rm -f "$BACKUP_CONFIG"
#+end_src

** Update P2Pool Script

#+begin_src bash :tangle ../configs/templates/update-p2pool.sh.j2
#!/bin/bash
# Update P2Pool to latest version
# Safe atomic update with automatic rollback on failure

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="{{ lookup('env', 'HOME') }}/literate-monero/config.yml"
BACKUP_CONFIG="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

# Get current version
CURRENT_VERSION=$(grep "^p2pool_version:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')

# Get latest version from GitHub
echo -e "${BLUE}Checking for latest P2Pool release...${NC}"
RELEASE_INFO=$(curl -s "https://api.github.com/repos/SChernykh/p2pool/releases/latest")
LATEST_VERSION=$(echo "$RELEASE_INFO" | grep '"tag_name"' | head -1 | cut -d'"' -f4)

if [ -z "$LATEST_VERSION" ]; then
    echo -e "${RED}Error: Could not determine latest version${NC}"
    exit 1
fi

# Compare versions
CURRENT_NORM="${CURRENT_VERSION#v}"
LATEST_NORM="${LATEST_VERSION#v}"

if [ "$CURRENT_NORM" = "$LATEST_NORM" ]; then
    echo -e "${GREEN}Already up to date: $CURRENT_VERSION${NC}"
    exit 0
fi

echo ""
echo -e "${YELLOW}Update Available:${NC}"
echo "  Current: $CURRENT_VERSION"
echo "  Latest:  $LATEST_VERSION"
echo ""
read -p "Proceed with update? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

echo ""
echo -e "${BLUE}=== Starting P2Pool Update ===${NC}"

# Backup current config
echo "Backing up config.yml..."
cp "$CONFIG_FILE" "$BACKUP_CONFIG"

# Update version in config.yml
echo "Updating config.yml to $LATEST_VERSION..."
sed -i "s/^p2pool_version:.*/p2pool_version: \"$LATEST_VERSION\"/" "$CONFIG_FILE"

# Re-tangle org files
echo "Re-tangling org files..."
cd "{{ lookup('env', 'HOME') }}/literate-monero"
./tangle.sh > /dev/null 2>&1

# Run Ansible to install new version
echo "Running Ansible playbook..."
cd ansible
if ansible-playbook playbook.yml --tags mining -v; then
    echo -e "${GREEN}✓ Ansible playbook completed successfully${NC}"
else
    echo -e "${RED}✗ Ansible playbook failed${NC}"
    echo "Rolling back to $CURRENT_VERSION..."
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"
    exit 1
fi

# Wait for service to start
echo "Waiting for P2Pool to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet p2pool; then
    echo -e "${GREEN}✓ P2Pool service is running${NC}"
else
    echo -e "${RED}✗ P2Pool service failed to start${NC}"
    echo "Rolling back to $CURRENT_VERSION..."

    # Restore config
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"

    # Repoint symlink to old version
    rm -f /opt/p2pool
    ln -s "/opt/p2pool-${CURRENT_VERSION}" /opt/p2pool

    # Restart service
    systemctl restart p2pool

    exit 1
fi

# Check logs for errors
echo "Checking P2Pool logs..."
sleep 5
if journalctl -u p2pool --since "30 seconds ago" --no-pager | grep -qi "error\|fatal\|failed"; then
    echo -e "${YELLOW}⚠ Warnings found in logs (review with: journalctl -u p2pool -n 50)${NC}"
else
    echo -e "${GREEN}✓ No errors in recent logs${NC}"
fi

echo ""
echo -e "${GREEN}=== P2Pool Update Complete ===${NC}"
echo "  Updated: $CURRENT_VERSION → $LATEST_VERSION"
echo "  Old version kept at: /opt/p2pool-${CURRENT_VERSION}"
echo "  Current version at: /opt/p2pool → /opt/p2pool-${LATEST_VERSION}"
echo ""
echo "Monitor status:"
echo "  sudo journalctl -u p2pool -f"
echo "  sudo mining-monitor.sh"
echo ""
echo "Rollback if needed:"
echo "  sudo rollback-p2pool.sh"
echo ""

# Clean up backup config after successful update
rm -f "$BACKUP_CONFIG"
#+end_src

** Update XMRig Script

#+begin_src bash :tangle ../configs/templates/update-xmrig.sh.j2
#!/bin/bash
# Update XMRig to latest version
# Safe atomic update with automatic rollback on failure

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

CONFIG_FILE="{{ lookup('env', 'HOME') }}/literate-monero/config.yml"
BACKUP_CONFIG="${CONFIG_FILE}.backup.$(date +%Y%m%d_%H%M%S)"

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

# Get current version
CURRENT_VERSION=$(grep "^xmrig_version:" "$CONFIG_FILE" | awk '{print $2}' | tr -d '"')

# Get latest version from GitHub
echo -e "${BLUE}Checking for latest XMRig release...${NC}"
RELEASE_INFO=$(curl -s "https://api.github.com/repos/xmrig/xmrig/releases/latest")
LATEST_VERSION=$(echo "$RELEASE_INFO" | grep '"tag_name"' | head -1 | cut -d'"' -f4)

if [ -z "$LATEST_VERSION" ]; then
    echo -e "${RED}Error: Could not determine latest version${NC}"
    exit 1
fi

# Compare versions
CURRENT_NORM="${CURRENT_VERSION#v}"
LATEST_NORM="${LATEST_VERSION#v}"

if [ "$CURRENT_NORM" = "$LATEST_NORM" ]; then
    echo -e "${GREEN}Already up to date: $CURRENT_VERSION${NC}"
    exit 0
fi

echo ""
echo -e "${YELLOW}Update Available:${NC}"
echo "  Current: $CURRENT_VERSION"
echo "  Latest:  $LATEST_VERSION"
echo ""
read -p "Proceed with update? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Update cancelled"
    exit 0
fi

echo ""
echo -e "${BLUE}=== Starting XMRig Update ===${NC}"
echo -e "${YELLOW}Note: XMRig build may take 5-10 minutes${NC}"
echo ""

# Backup current config
echo "Backing up config.yml..."
cp "$CONFIG_FILE" "$BACKUP_CONFIG"

# Update version in config.yml
echo "Updating config.yml to $LATEST_VERSION..."
sed -i "s/^xmrig_version:.*/xmrig_version: \"$LATEST_VERSION\"/" "$CONFIG_FILE"

# Re-tangle org files
echo "Re-tangling org files..."
cd "{{ lookup('env', 'HOME') }}/literate-monero"
./tangle.sh > /dev/null 2>&1

# Run Ansible to install new version
echo "Running Ansible playbook (this will take several minutes)..."
cd ansible
if ansible-playbook playbook.yml --tags mining -v; then
    echo -e "${GREEN}✓ Ansible playbook completed successfully${NC}"
else
    echo -e "${RED}✗ Ansible playbook failed${NC}"
    echo "Rolling back to $CURRENT_VERSION..."
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"
    exit 1
fi

# Wait for service to start
echo "Waiting for XMRig to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet xmrig; then
    echo -e "${GREEN}✓ XMRig service is running${NC}"
else
    echo -e "${RED}✗ XMRig service failed to start${NC}"
    echo "Rolling back to $CURRENT_VERSION..."

    # Restore config
    cp "$BACKUP_CONFIG" "$CONFIG_FILE"

    # Repoint symlink to old version
    rm -f /opt/xmrig
    ln -s "/opt/xmrig-${CURRENT_VERSION}" /opt/xmrig

    # Restart service
    systemctl restart xmrig

    exit 1
fi

# Check for hashrate in logs
echo "Checking mining performance..."
sleep 15
if journalctl -u xmrig --since "30 seconds ago" --no-pager | grep -qi "speed"; then
    HASHRATE=$(journalctl -u xmrig --since "30 seconds ago" --no-pager | grep "speed" | tail -n 1)
    echo -e "${GREEN}✓ Mining active:${NC}"
    echo "  $HASHRATE"
else
    echo -e "${YELLOW}⚠ No hashrate data yet (may still be initializing)${NC}"
fi

echo ""
echo -e "${GREEN}=== XMRig Update Complete ===${NC}"
echo "  Updated: $CURRENT_VERSION → $LATEST_VERSION"
echo "  Old version kept at: /opt/xmrig-${CURRENT_VERSION}"
echo "  Current version at: /opt/xmrig → /opt/xmrig-${LATEST_VERSION}"
echo ""
echo "Monitor status:"
echo "  sudo journalctl -u xmrig -f"
echo "  sudo mining-monitor.sh"
echo ""
echo "Rollback if needed:"
echo "  sudo rollback-xmrig.sh"
echo ""

# Clean up backup config after successful update
rm -f "$BACKUP_CONFIG"
#+end_src

** Rollback Monerod Script

#+begin_src bash :tangle ../configs/templates/rollback-monerod.sh.j2
#!/bin/bash
# Rollback monerod to a previous version

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

echo -e "${BLUE}=== Monerod Rollback ===${NC}"
echo ""

# List available versions
echo "Available monerod versions:"
VERSIONS=()
INDEX=1
for dir in /opt/monero-*; do
    if [ -d "$dir" ]; then
        VERSION=$(basename "$dir" | sed 's/monero-//')
        VERSIONS+=("$VERSION")

        # Check if this is current version
        CURRENT=$(readlink -f /opt/monero 2>/dev/null | xargs basename 2>/dev/null | sed 's/monero-//')
        if [ "$VERSION" = "$CURRENT" ]; then
            echo "  $INDEX) $VERSION ${GREEN}(current)${NC}"
        else
            echo "  $INDEX) $VERSION"
        fi
        ((INDEX++))
    fi
done

if [ ${#VERSIONS[@]} -eq 0 ]; then
    echo -e "${RED}No monerod versions found in /opt${NC}"
    exit 1
fi

echo ""
read -p "Select version to rollback to (1-${#VERSIONS[@]}): " SELECTION

if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt ${#VERSIONS[@]} ]; then
    echo -e "${RED}Invalid selection${NC}"
    exit 1
fi

TARGET_VERSION="${VERSIONS[$((SELECTION-1))]}"

echo ""
echo -e "${YELLOW}Rolling back to: $TARGET_VERSION${NC}"
read -p "Proceed? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Rollback cancelled"
    exit 0
fi

# Stop service
echo "Stopping monerod..."
systemctl stop monerod

# Repoint symlink
echo "Updating symlink..."
rm -f /opt/monero
ln -s "/opt/monero-${TARGET_VERSION}" /opt/monero

# Start service
echo "Starting monerod..."
systemctl start monerod

# Wait for service
echo "Waiting for service to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet monerod; then
    echo -e "${GREEN}✓ Monerod service is running${NC}"
else
    echo -e "${RED}✗ Monerod service failed to start${NC}"
    journalctl -u monerod -n 20
    exit 1
fi

# Test RPC
echo "Testing RPC connectivity..."
if curl -s --max-time 10 "http://127.0.0.1:{{ monerod_rpc_port }}/json_rpc" \
    -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
    -H 'Content-Type: application/json' | grep -q '"status":"OK"'; then
    echo -e "${GREEN}✓ RPC responding correctly${NC}"
else
    echo -e "${RED}✗ RPC not responding${NC}"
    exit 1
fi

echo ""
echo -e "${GREEN}=== Rollback Complete ===${NC}"
echo "  Monerod now running: $TARGET_VERSION"
echo ""
echo "Monitor status:"
echo "  sudo monerod-status.sh"
echo "  sudo journalctl -u monerod -f"
echo ""
#+end_src

** Rollback P2Pool Script

#+begin_src bash :tangle ../configs/templates/rollback-p2pool.sh.j2
#!/bin/bash
# Rollback P2Pool to a previous version

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

echo -e "${BLUE}=== P2Pool Rollback ===${NC}"
echo ""

# List available versions
echo "Available P2Pool versions:"
VERSIONS=()
INDEX=1
for dir in /opt/p2pool-*; do
    if [ -d "$dir" ]; then
        VERSION=$(basename "$dir" | sed 's/p2pool-//')
        VERSIONS+=("$VERSION")

        # Check if this is current version
        CURRENT=$(readlink -f /opt/p2pool 2>/dev/null | xargs basename 2>/dev/null | sed 's/p2pool-//')
        if [ "$VERSION" = "$CURRENT" ]; then
            echo "  $INDEX) $VERSION ${GREEN}(current)${NC}"
        else
            echo "  $INDEX) $VERSION"
        fi
        ((INDEX++))
    fi
done

if [ ${#VERSIONS[@]} -eq 0 ]; then
    echo -e "${RED}No P2Pool versions found in /opt${NC}"
    exit 1
fi

echo ""
read -p "Select version to rollback to (1-${#VERSIONS[@]}): " SELECTION

if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt ${#VERSIONS[@]} ]; then
    echo -e "${RED}Invalid selection${NC}"
    exit 1
fi

TARGET_VERSION="${VERSIONS[$((SELECTION-1))]}"

echo ""
echo -e "${YELLOW}Rolling back to: $TARGET_VERSION${NC}"
read -p "Proceed? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Rollback cancelled"
    exit 0
fi

# Stop service
echo "Stopping P2Pool..."
systemctl stop p2pool

# Repoint symlink
echo "Updating symlink..."
rm -f /opt/p2pool
ln -s "/opt/p2pool-${TARGET_VERSION}" /opt/p2pool

# Start service
echo "Starting P2Pool..."
systemctl start p2pool

# Wait for service
echo "Waiting for service to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet p2pool; then
    echo -e "${GREEN}✓ P2Pool service is running${NC}"
else
    echo -e "${RED}✗ P2Pool service failed to start${NC}"
    journalctl -u p2pool -n 20
    exit 1
fi

echo ""
echo -e "${GREEN}=== Rollback Complete ===${NC}"
echo "  P2Pool now running: $TARGET_VERSION"
echo ""
echo "Monitor status:"
echo "  sudo journalctl -u p2pool -f"
echo "  sudo mining-monitor.sh"
echo ""
#+end_src

** Rollback XMRig Script

#+begin_src bash :tangle ../configs/templates/rollback-xmrig.sh.j2
#!/bin/bash
# Rollback XMRig to a previous version

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo -e "${RED}Error: Must run as root${NC}"
    exit 1
fi

echo -e "${BLUE}=== XMRig Rollback ===${NC}"
echo ""

# List available versions
echo "Available XMRig versions:"
VERSIONS=()
INDEX=1
for dir in /opt/xmrig-*; do
    if [ -d "$dir" ]; then
        VERSION=$(basename "$dir" | sed 's/xmrig-//')
        VERSIONS+=("$VERSION")

        # Check if this is current version
        CURRENT=$(readlink -f /opt/xmrig 2>/dev/null | xargs basename 2>/dev/null | sed 's/xmrig-//')
        if [ "$VERSION" = "$CURRENT" ]; then
            echo "  $INDEX) $VERSION ${GREEN}(current)${NC}"
        else
            echo "  $INDEX) $VERSION"
        fi
        ((INDEX++))
    fi
done

if [ ${#VERSIONS[@]} -eq 0 ]; then
    echo -e "${RED}No XMRig versions found in /opt${NC}"
    exit 1
fi

echo ""
read -p "Select version to rollback to (1-${#VERSIONS[@]}): " SELECTION

if ! [[ "$SELECTION" =~ ^[0-9]+$ ]] || [ "$SELECTION" -lt 1 ] || [ "$SELECTION" -gt ${#VERSIONS[@]} ]; then
    echo -e "${RED}Invalid selection${NC}"
    exit 1
fi

TARGET_VERSION="${VERSIONS[$((SELECTION-1))]}"

echo ""
echo -e "${YELLOW}Rolling back to: $TARGET_VERSION${NC}"
read -p "Proceed? (y/N) " -n 1 -r
echo
if [[ ! $REPLY =~ ^[Yy]$ ]]; then
    echo "Rollback cancelled"
    exit 0
fi

# Stop service
echo "Stopping XMRig..."
systemctl stop xmrig

# Repoint symlink
echo "Updating symlink..."
rm -f /opt/xmrig
ln -s "/opt/xmrig-${TARGET_VERSION}" /opt/xmrig

# Start service
echo "Starting XMRig..."
systemctl start xmrig

# Wait for service
echo "Waiting for service to start..."
sleep 10

# Verify service is running
if systemctl is-active --quiet xmrig; then
    echo -e "${GREEN}✓ XMRig service is running${NC}"
else
    echo -e "${RED}✗ XMRig service failed to start${NC}"
    journalctl -u xmrig -n 20
    exit 1
fi

# Check for hashrate
echo "Checking mining performance..."
sleep 15
if journalctl -u xmrig --since "30 seconds ago" --no-pager | grep -qi "speed"; then
    HASHRATE=$(journalctl -u xmrig --since "30 seconds ago" --no-pager | grep "speed" | tail -n 1)
    echo -e "${GREEN}✓ Mining active:${NC}"
    echo "  $HASHRATE"
else
    echo -e "${YELLOW}⚠ No hashrate data yet${NC}"
fi

echo ""
echo -e "${GREEN}=== Rollback Complete ===${NC}"
echo "  XMRig now running: $TARGET_VERSION"
echo ""
echo "Monitor status:"
echo "  sudo journalctl -u xmrig -f"
echo "  sudo mining-monitor.sh"
echo ""
#+end_src

** Deploy Update Management Scripts

#+begin_src yaml :tangle ../ansible/fragments/97-updates.yml
    # ------------------------------------------------------------------------
    # Update Management
    # ------------------------------------------------------------------------

    - name: Deploy update management scripts
      template:
        src: "../configs/templates/{{ item }}.j2"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - check-updates.sh
        - update-monerod.sh
        - update-p2pool.sh
        - update-xmrig.sh
        - rollback-monerod.sh
        - rollback-p2pool.sh
        - rollback-xmrig.sh
      tags: [updates, scripts]
#+end_src

** Optional: Automated Update Checking

#+begin_src yaml :tangle ../ansible/fragments/97-updates.yml
    - name: Create weekly update check cron job
      cron:
        name: "Check for software updates"
        minute: "0"
        hour: "9"
        weekday: "1"
        job: "/usr/local/bin/check-updates.sh >> /var/log/updates-available.log 2>&1"
        user: root
      tags: [updates, cron]
      when: auto_check_updates | default(false)
#+end_src

** Verify Update Management Setup

#+begin_src yaml :tangle ../ansible/fragments/97-updates.yml
    - name: Verify update scripts are installed
      stat:
        path: "/usr/local/bin/{{ item }}"
      register: update_scripts
      loop:
        - check-updates.sh
        - update-monerod.sh
        - rollback-monerod.sh
      tags: [updates, verify]

    - name: Display update management status
      debug:
        msg:
          - "=== Update Management Setup Complete ==="
          - ""
          - "Available commands:"
          - "  sudo check-updates.sh        # Check for available updates"
          - ""
          - "Update commands:"
          - "  sudo update-monerod.sh       # Update Monerod"
          - "  sudo update-p2pool.sh        # Update P2Pool"
          - "  sudo update-xmrig.sh         # Update XMRig"
          - ""
          - "Rollback commands:"
          - "  sudo rollback-monerod.sh     # Rollback Monerod"
          - "  sudo rollback-p2pool.sh      # Rollback P2Pool"
          - "  sudo rollback-xmrig.sh       # Rollback XMRig"
          - ""
          - "All updates are atomic with automatic rollback on failure"
          - "Old versions are kept in /opt/<component>-<version>"
          - ""
      tags: [updates, verify]
#+end_src

** Notes

*** Update Process

Each component update follows this safe pattern:

1. **Check** - Query GitHub for latest version
2. **Confirm** - Interactive prompt showing current → new version
3. **Backup** - Save config.yml before changes
4. **Update** - Modify config.yml, re-tangle, run Ansible
5. **Verify** - Test service health and functionality
6. **Rollback** - Automatic on any failure, restores old version

Updates are atomic (symlink switch) so rollback is instant.

*** Version Management

- Each version installed to: `/opt/<component>-<version>/`
- Current version via symlink: `/opt/<component>` → `/opt/<component>-<version>/`
- Old versions kept until manual cleanup
- Rollback just repoints symlink and restarts service

*** GitHub API Rate Limits

- Public GitHub API: 60 requests/hour without auth
- Checking 3 components = 3 requests
- Weekly automated checks stay well within limits
- Rate limit errors handled gracefully (shows "unknown" version)

*** Safety Features

**Automatic rollback on:**
- Ansible playbook failure
- Service fails to start
- RPC/connectivity tests fail (monerod)
- No hashrate after 15 seconds (XMRig)

**Manual rollback:**
- Lists all installed versions
- Interactive selection
- Instant symlink switch + restart
- No re-download or re-build needed

*** Disk Space

Each version takes space:
- Monerod: ~100MB per version
- P2Pool: ~10MB per version
- XMRig: ~50MB per version (includes build artifacts)

Old versions can be removed manually:
```bash
sudo rm -rf /opt/monero-v0.18.3.4
sudo rm -rf /opt/p2pool-v4.11
sudo rm -rf /opt/xmrig-v6.21.3
```

Never remove the version currently linked by `/opt/<component>`.

*** Automated Update Checking

Optional weekly cron job logs available updates:
```bash
# Enable in config.yml
auto_check_updates: true

# View available updates
tail /var/log/updates-available.log
```

Updates are NEVER applied automatically - admin reviews and decides when to update.

*** Testing Updates

Before updating production:
1. Check current status: `sudo system-status.sh`
2. Check for updates: `sudo check-updates.sh`
3. Read release notes (URLs in check-updates output)
4. Apply update during low-activity period
5. Monitor logs: `sudo journalctl -u <service> -f`
6. Rollback if issues: `sudo rollback-<component>.sh`

*** XMRig Build Time

XMRig updates take 5-10 minutes because it builds from source. This is normal.

Monerod and P2Pool are pre-compiled binaries (faster).

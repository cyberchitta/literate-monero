** Overview

This phase configures privacy wrappers for applications - routing specific tools through the privacy infrastructure installed in Phase 3:
- Configure git to route through Tor
- Configure SSH to route through Tor
- Generate SSH keys for git hosting
- Set up workspace directory
- Set up shared Tor Browser profile infrastructure for GitHub-authenticated apps

**Pattern established:** This shows how to take any application/workflow and route it through Tor. Currently focused on development tools (git, SSH), but the same pattern applies to any privacy-sensitive workflow.

**Prerequisites:** Phase 3 (privacy) must be complete - Tor daemon must be running with SOCKS proxy on port {{ tor_socks_port }}.

** Threat Model for Development Operations

**What this protects:**
- ✓ IP hidden from GitHub/GitLab (Tor routing)
- ✓ Git commits don't leak location
- ✓ SSH connections routed through Tor

**What this doesn't protect:**
- GitHub/GitLab knows your account (if you're logged in)
- Commit metadata (name, email) is in git config
- Repository content is visible to hosting provider

Trade-off: Operational privacy for development, not anonymity from hosting providers.

** Git Privacy Configuration

*** Git Configuration Template

#+begin_src gitconfig :tangle ../configs/templates/anon-gitconfig.j2
[user]
	name = {{ anon_git_name }}
	email = {{ anon_git_email }}

[http]
	proxy = socks5://127.0.0.1:{{ tor_socks_port }}
[https]
	proxy = socks5://127.0.0.1:{{ tor_socks_port }}

[core]
	editor = vim
	autocrlf = input

[init]
	defaultBranch = main

[pull]
	rebase = false

[push]
	default = simple

[commit]
	gpgsign = false

# Avoid leaking system information
[advice]
	detachedHead = false
#+end_src

*** SSH Configuration Template

#+begin_src sshconfig :tangle ../configs/templates/anon-ssh-config.j2
# SSH configuration for privacy-first git operations
# Routes all git traffic through Tor SOCKS proxy

Host github.com
    HostName github.com
    User git
    Port 22
    ProxyCommand nc -X 5 -x 127.0.0.1:{{ tor_socks_port }} %h %p
    IdentityFile ~/.ssh/id_ed25519_github
    IdentitiesOnly yes
    ServerAliveInterval 60
    ServerAliveCountMax 10

Host gitlab.com
    HostName gitlab.com
    User git
    Port 22
    ProxyCommand nc -X 5 -x 127.0.0.1:{{ tor_socks_port }} %h %p
    IdentityFile ~/.ssh/id_ed25519_gitlab
    IdentitiesOnly yes
    ServerAliveInterval 60
    ServerAliveCountMax 10

# Catch-all for other git hosts
Host *.github.com *.gitlab.com
    ProxyCommand nc -X 5 -x 127.0.0.1:{{ tor_socks_port }} %h %p
#+end_src

*** Deploy Privacy Configuration

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    # ------------------------------------------------------------------------
    # Privacy Wrappers for Applications
    # ------------------------------------------------------------------------

    - name: Ensure primary user .ssh directory exists
      file:
        path: "/home/{{ dev_user }}/.ssh"
        state: directory
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0700'
      tags: [privacy-wrappers, config]

    - name: Deploy git configuration for privacy
      template:
        src: ../configs/templates/anon-gitconfig.j2
        dest: "/home/{{ dev_user }}/.gitconfig"
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0644'
      tags: [privacy-wrappers, config]

    - name: Deploy SSH configuration for Tor routing
      template:
        src: ../configs/templates/anon-ssh-config.j2
        dest: "/home/{{ dev_user }}/.ssh/config"
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0600'
      tags: [privacy-wrappers, config]

    - name: Create workspace directory
      file:
        path: "/home/{{ dev_user }}/projects"
        state: directory
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0755'
      tags: [privacy-wrappers, config]
#+end_src

*** Generate SSH Keys Script

#+begin_src bash :tangle ../configs/templates/generate-git-keys.sh.j2
#!/bin/bash
# Generate SSH keys for git hosting (see 04-privacy-wrappers.org)

set -euo pipefail

if [ "$(whoami)" != "{{ dev_user }}" ]; then
    echo "ERROR: Run as {{ dev_user }} user"
    exit 1
fi

SERVICE="${1:-}"

if [ -z "$SERVICE" ]; then
    echo "Usage: $0 <service>"
    echo "Examples: $0 github | $0 gitlab"
    exit 1
fi

KEY_FILE="$HOME/.ssh/id_ed25519_$SERVICE"

if [ -f "$KEY_FILE" ]; then
    read -p "Key exists. Overwrite? (y/N) " -n 1 -r
    echo
    [[ ! $REPLY =~ ^[Yy]$ ]] && exit 1
fi

ssh-keygen -t ed25519 -C "{{ anon_git_email }}" -f "$KEY_FILE" -N ""

echo ""
echo "=== Public Key (add to $SERVICE) ==="
cat "${KEY_FILE}.pub"
echo ""
#+end_src

** Deploy Helper Scripts

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    # ------------------------------------------------------------------------
    # Privacy Wrapper Helper Scripts
    # ------------------------------------------------------------------------

    - name: Deploy privacy wrapper helper scripts
      template:
        src: "../configs/templates/{{ item }}.j2"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - generate-git-keys.sh
      tags: [privacy-wrappers, scripts]
#+end_src

** Verify Privacy Wrappers

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    # ------------------------------------------------------------------------
    # Privacy Wrappers Verification
    # ------------------------------------------------------------------------

    - name: Check git configuration
      stat:
        path: "/home/{{ dev_user }}/.gitconfig"
      register: git_config
      tags: [privacy-wrappers, verify]

    - name: Check SSH config
      stat:
        path: "/home/{{ dev_user }}/.ssh/config"
      register: ssh_config
      tags: [privacy-wrappers, verify]

    - name: Display privacy wrappers status
      debug:
        msg:
          - "=== Privacy Wrappers Configuration Complete ==="
          - ""
          - "Git config: {% if git_config.stat.exists %}Installed{% else %}Not found{% endif %}"
          - "  Name: {{ anon_git_name }}"
          - "  Email: {{ anon_git_email }}"
          - "  HTTP/HTTPS proxy: socks5://127.0.0.1:{{ tor_socks_port }}"
          - ""
          - "SSH config: {% if ssh_config.stat.exists %}Installed{% else %}Not found{% endif %}"
          - "  Routes: github.com, gitlab.com through Tor"
          - ""
          - "Workspace: /home/{{ dev_user }}/projects"
          - ""
          - "Next steps:"
          - "1. Generate SSH keys: /usr/local/bin/generate-git-keys.sh github"
          - "2. Save public key for later (add to GitHub when ready)"
          - "3. Test: ssh -T git@github.com"
          - ""
          - "Git operations will route through Tor automatically"
          - ""
      tags: [privacy-wrappers, verify]
#+end_src

** Notes

*** Quick Operations

#+begin_example
# Generate SSH keys for git hosting
/usr/local/bin/generate-git-keys.sh github
/usr/local/bin/generate-git-keys.sh gitlab

# Test SSH connection through Tor
ssh -T git@github.com

# Clone repository (automatically uses Tor)
cd ~/projects
git clone git@github.com:user/repo.git
#+end_example

*** How Git Routing Works

**HTTP/HTTPS operations (git clone https://...):**
- Git uses HTTP proxy settings from `.gitconfig`
- All traffic routes through Tor SOCKS proxy
- Your IP is hidden from GitHub/GitLab

**SSH operations (git clone git@...):**
- SSH uses ProxyCommand from `.ssh/config`
- netcat tunnels connection through Tor SOCKS proxy
- Your IP is hidden from GitHub/GitLab

**Test routing:**
```bash
# Should show GitHub authentication success (not your real IP)
ssh -T git@github.com
```

*** SSH Keys for Git Hosting

**Purpose:** These keys authenticate git operations (push, pull) to GitHub/GitLab.

**Not the same as:** Server access keys (configured in Phase 2: WireGuard)

**Security model:**
- Keys generated locally
- Public key uploaded to GitHub/GitLab (in your account settings)
- Private key stays on your system
- All git operations route through Tor

**Adding keys to GitHub:**
1. Generate: `/usr/local/bin/generate-git-keys.sh github`
2. Copy public key output
3. Log into GitHub via Tor Browser
4. Settings → SSH and GPG keys → New SSH key
5. Paste public key
6. Test: `ssh -T git@github.com`

*** Git Identity

Configured in `.gitconfig`:
- Name: {{ anon_git_name }}
- Email: {{ anon_git_email }}

This appears in commit metadata. Set to pseudonym for privacy.

**Note:** Commit content and messages still reveal information about you. This wrapper provides network-level privacy (IP hidden), not content anonymity.

*** Extending the Pattern

This phase demonstrates the pattern for routing applications through Tor. To add privacy wrappers for other tools:

1. Identify the tool's network configuration
2. Route through SOCKS proxy (127.0.0.1:{{ tor_socks_port }})
3. Create wrapper script if needed
4. Add to this phase

**Example tools that could use this pattern:**
- IRC client (route through Tor)
- Email client (route through Tor)
- RSS reader (route through Tor)
- Chat applications (route through Tor)

All follow the same pattern: configure to use `socks5://127.0.0.1:{{ tor_socks_port }}`.

*** Troubleshooting

**Git operations fail:**
```bash
# Check Tor is running
check-privacy.sh

# Test Tor SOCKS proxy
curl --socks5 127.0.0.1:{{ tor_socks_port }} https://check.torproject.org/api/ip

# Restart Tor
sudo systemctl restart tor
```

**SSH to GitHub fails:**
```bash
# Verbose SSH output
ssh -vT git@github.com

# Check SSH config syntax
ssh -G github.com | grep -i proxy
```

**Key authentication fails:**
```bash
# Verify key exists
ls -la ~/.ssh/id_ed25519_github*

# Check key is in SSH config
grep -A 5 "github.com" ~/.ssh/config
```

** GitHub-Authenticated Applications

This section configures desktop applications that use GitHub for authentication (GitHub, Element, etc.) to run in a shared Tor Browser profile. All apps share the same Tor circuit and GitHub session.

*** Helper Script

#+begin_src bash :tangle ../configs/templates/github-auth-browser.sh.j2
#!/bin/bash
# github-auth-browser.sh
# Manages shared Tor Browser profile for GitHub-authenticated apps
#
# Usage:
#   github-auth-browser.sh <url> [mode] [title-pattern]
#
# Arguments:
#   url            - URL to open (default: https://github.com)
#   mode           - "focus" (default) or "own-window"
#   title-pattern  - String to match in window title (required for own-window)

PROFILE_DIR="$HOME/.tor-browser-profiles/github-auth"
TOR_BROWSER="/opt/tor-browser/Browser/start-tor-browser"
URL="${1:-https://github.com}"
MODE="${2:-focus}"
TITLE_PATTERN="${3:-}"

mkdir -p "$PROFILE_DIR"

# Check if Tor Browser with this profile is running
if BROWSER_PID=$(pgrep -f "profile.*github-auth"); then
    if [ "$MODE" = "own-window" ]; then
        if [ -z "$TITLE_PATTERN" ]; then
            echo "Error: title-pattern required for own-window mode" >&2
            exit 1
        fi

        # Check if window with this title pattern exists
        WINDOW=$(hyprctl clients -j | jq -r ".[] | select(.pid == $BROWSER_PID and (.title | contains(\"$TITLE_PATTERN\"))) | .address" | head -1)

        if [ -n "$WINDOW" ]; then
            # Window exists - focus it
            hyprctl dispatch focuswindow "address:$WINDOW"
        else
            # Window doesn't exist - create new window
            "$TOR_BROWSER" --profile "$PROFILE_DIR" --new-window "$URL" &
        fi
    else
        # Just focus any existing window
        WINDOW=$(hyprctl clients -j | jq -r ".[] | select(.pid == $BROWSER_PID) | .address" | head -1)
        if [ -n "$WINDOW" ]; then
            hyprctl dispatch focuswindow "address:$WINDOW"
        fi
    fi
else
    # Start new instance with github-auth profile
    "$TOR_BROWSER" --profile "$PROFILE_DIR" "$URL" &
fi
#+end_src

*** GitHub Browser Script

#+begin_src bash :tangle ../configs/templates/github-browser.sh.j2
#!/bin/bash
# Open GitHub in shared Tor Browser profile
# Focuses any existing window in the profile
/usr/local/bin/github-auth-browser.sh https://github.com focus
#+end_src

*** Deploy Scripts

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    # ------------------------------------------------------------------------
    # GitHub-Authenticated Browser Infrastructure
    # ------------------------------------------------------------------------

    - name: Deploy GitHub-auth browser helper script
      template:
        src: ../configs/templates/github-auth-browser.sh.j2
        dest: /usr/local/bin/github-auth-browser.sh
        mode: '0755'
      tags: [privacy-wrappers, browser]

    - name: Deploy GitHub browser script
      template:
        src: ../configs/templates/github-browser.sh.j2
        dest: /usr/local/bin/github-browser.sh
        mode: '0755'
      tags: [privacy-wrappers, browser]
#+end_src

*** Download GitHub Icon

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    - name: Download GitHub icon
      get_url:
        url: "https://github.githubassets.com/images/modules/logos_page/GitHub-Mark.png"
        dest: /usr/share/icons/github.png
        mode: '0644'
      tags: [privacy-wrappers, browser]
#+end_src

*** GitHub Desktop Entry

#+begin_src yaml :tangle ../ansible/fragments/04-privacy-wrappers.yml
    - name: Create GitHub desktop entry
      copy:
        content: |
          [Desktop Entry]
          Name=GitHub
          GenericName=GitHub Browser
          Comment=Open GitHub in Tor Browser
          Exec=/usr/local/bin/github-browser.sh
          Icon=/usr/share/icons/github.png
          Terminal=false
          Type=Application
          Categories=Network;Development;
        dest: /usr/share/applications/github.desktop
        mode: '0644'
      tags: [privacy-wrappers, browser]
#+end_src

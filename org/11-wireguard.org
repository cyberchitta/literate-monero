** Overview

This phase installs WireGuard, generates keys, configures the tunnel, and sets up peer management.

** SSH Keys Note

See Appendix G: Component-Specific Rationale (SSH Key Separation) for server vs git key workflows.

** Prerequisites

Base system phase must be complete. UDP port 51820 must be accessible (forwarded if behind NAT).

** Install WireGuard

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    # ------------------------------------------------------------------------
    # WireGuard Secure Access
    # ------------------------------------------------------------------------

    - name: Install WireGuard
      community.general.pacman:
        name:
          - wireguard-tools
          - openresolv
        state: present
      tags: [wireguard]
#+end_src

** Generate Server Keys

WireGuard uses public-key cryptography. Each peer has a private/public key pair.

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Check if WireGuard server keys exist
      stat:
        path: /etc/wireguard/server-private.key
      register: wg_server_key
      tags: [wireguard]

    - name: Generate WireGuard server private key
      shell: wg genkey > /etc/wireguard/server-private.key
      when:
        - not wg_server_key.stat.exists
      tags: [wireguard]

    - name: Generate WireGuard server public key
      shell: wg pubkey < /etc/wireguard/server-private.key > /etc/wireguard/server-public.key
      when:
        - not wg_server_key.stat.exists
      tags: [wireguard]

    - name: Set permissions on server keys
      file:
        path: "{{ item }}"
        mode: '0600'
        owner: root
        group: root
      loop:
        - /etc/wireguard/server-private.key
        - /etc/wireguard/server-public.key
      tags: [wireguard]

    - name: Read server public key
      slurp:
        src: /etc/wireguard/server-public.key
      register: wg_server_pubkey
      tags: [wireguard, verify]

    - name: Read server private key
      slurp:
        src: /etc/wireguard/server-private.key
      register: wg_server_privkey
      tags: [wireguard, config]
#+end_src

** WireGuard Server Configuration Template

The server configuration defines the tunnel interface and authorized peers.

#+begin_src jinja2 :tangle ../configs/templates/wg0.conf.j2
# WireGuard Server Configuration
# Generated from org/02-wireguard.org

[Interface]
# Server IP on WireGuard network
Address = {{ wireguard_server_ip }}/24

# Listen port for WireGuard traffic
ListenPort = {{ wireguard_port }}

# Server private key (generated during installation)
PrivateKey = {{ wg_server_privkey['content'] | b64decode | trim }}

# Optional: Post-up/down commands for routing
# Uncomment if you want server to route internet through WireGuard
# PostUp = iptables -A FORWARD -i %i -j ACCEPT; iptables -A FORWARD -o %i -j ACCEPT; iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
# PostDown = iptables -D FORWARD -i %i -j ACCEPT; iptables -D FORWARD -o %i -j ACCEPT; iptables -t nat -D POSTROUTING -o eth0 -j MASQUERADE

# Peers will be added below by wireguard-add-peer.sh script
# Example peer configuration:
#
# [Peer]
# PublicKey = <peer-public-key>
# AllowedIPs = 10.8.0.2/32
#+end_src

** Deploy WireGuard Configuration

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Deploy WireGuard configuration
      template:
        src: ../configs/templates/wg0.conf.j2
        dest: /etc/wireguard/wg0.conf
        mode: '0600'
        owner: root
        group: root
        force: no
      tags: [wireguard, config]

    - name: Enable IP forwarding for WireGuard
      sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        state: present
        reload: yes
      tags: [wireguard]

    - name: Make IP forwarding persistent
      lineinfile:
        path: /etc/sysctl.d/99-wireguard.conf
        line: "net.ipv4.ip_forward = 1"
        create: yes
        mode: '0644'
      tags: [wireguard]
#+end_src

** Firewall Configuration

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Allow WireGuard port through firewall
      community.general.ufw:
        rule: allow
        port: "{{ item.port }}"
        proto: "{{ item.proto }}"
        comment: "{{ item.comment | default(omit) }}"
      loop: "{{ firewall_service_rules | selectattr('comment', 'search', 'WireGuard') | list }}"
      tags: [wireguard, firewall]
#+end_src

** Configure SSH Access

SSH access has two phases:
- wireguard_only: false (default): SSH open on port 22 for initial setup
- wireguard_only: true: SSH only via WireGuard tunnel (set after verifying WireGuard works)

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Configure SSH firewall rules based on WireGuard phase
      block:
        # Initial setup - SSH port open
        - name: Allow SSH from anywhere (initial setup)
          community.general.ufw:
            rule: allow
            port: "{{ ssh_port }}"
            proto: tcp
            comment: "SSH access - test WireGuard before restricting"
          when: not (wireguard_only | default(false))
          tags: [wireguard, firewall, ssh]

        # Normal operation - SSH only via WireGuard
        - name: Allow SSH only from WireGuard network
          community.general.ufw:
            rule: allow
            from_ip: "{{ wireguard_network }}"
            port: "{{ ssh_port }}"
            proto: tcp
            comment: "SSH via WireGuard only"
          when: wireguard_only | default(false)
          tags: [wireguard, firewall, ssh]

        - name: Remove public SSH access
          community.general.ufw:
            rule: allow
            port: "{{ ssh_port }}"
            proto: tcp
            delete: yes
          when: wireguard_only | default(false)
          failed_when: false
          tags: [wireguard, firewall, ssh]

        - name: Display SSH access configuration
          debug:
            msg:
              - "=== SSH Access Configuration ==="
              - ""
              - "Phase: {% if not (wireguard_only | default(false)) %}Initial Setup (port {{ ssh_port }} open){% else %}Secured (SSH only via WireGuard {{ wireguard_server_ip }}){% endif %}"
              - ""
              - "{% if not (wireguard_only | default(false)) %}After verifying WireGuard works:{% endif %}"
              - "{% if not (wireguard_only | default(false)) %}1. Test: ssh {{ dev_user }}@{{ wireguard_server_ip }}{% endif %}"
              - "{% if not (wireguard_only | default(false)) %}2. Edit config.yml: wireguard_only: true{% endif %}"
              - "{% if not (wireguard_only | default(false)) %}3. Re-run: ansible-playbook playbook.yml --tags firewall{% endif %}"
              - ""
              - "{% if wireguard_only | default(false) %}✓ SSH secured via WireGuard tunnel{% endif %}"
          tags: [wireguard, firewall, ssh]
      tags: [wireguard, firewall]
#+end_src

** Verify SSH Access Configuration

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Verify SSH firewall rules
      shell: ufw status numbered | grep "{{ ssh_port }}/tcp"
      register: ssh_rules
      changed_when: false
      failed_when: false
      tags: [wireguard, verify]

    - name: Parse SSH firewall rule
      set_fact:
        ssh_rule_line: "{{ ssh_rules.stdout_lines[0] if ssh_rules.stdout_lines else '' }}"
      when: ssh_rules.rc == 0
      tags: [wireguard, verify]

    - name: Verify SSH firewall rule is correct
      assert:
        that:
          - ssh_rules.rc == 0
          - ssh_rules.stdout_lines | length >= 1
          - ssh_rules.stdout_lines | length <= 2  # IPv4 + optional IPv6
          - (wireguard_only | default(false) and '10.8.0.0/24' in ssh_rules.stdout) or (not (wireguard_only | default(false)) and ('Anywhere' in ssh_rules.stdout or '0.0.0.0' in ssh_rules.stdout))
        fail_msg: |
          SSH firewall configuration error!
          Found {{ ssh_rules.stdout_lines | length }} SSH rule(s)

          Current rules:
          {{ ssh_rules.stdout }}

          Expected configuration:
          {% if wireguard_only | default(false) %}
          - SSH only from WireGuard network (10.8.0.0/24)
          {% else %}
          - SSH allowed from anywhere (initial setup)
          {% endif %}

          To fix:
          1. Reset firewall: sudo ufw reset
          2. Re-run: ansible-playbook playbook.yml --tags firewall
        success_msg: "✓ SSH firewall configured correctly ({{ wireguard_only | default(false) | ternary('WireGuard only', 'Open for setup') }})"
      tags: [wireguard, verify]
#+end_src

** Start WireGuard Service

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Enable and start WireGuard
      systemd:
        name: wg-quick@wg0
        enabled: yes
        state: started
      tags: [wireguard]

    - name: Wait for WireGuard interface to be ready
      wait_for:
        timeout: 5
      tags: [wireguard]

    - name: Verify WireGuard interface exists
      command: ip link show wg0
      register: wg_interface
      changed_when: false
      tags: [wireguard, verify]

    - name: Test WireGuard peer connectivity
      shell: |
        PEER_COUNT=$(wg show wg0 peers | wc -l)
        if [ $PEER_COUNT -eq 0 ]; then
          echo "no_peers"
          exit 0
        fi

        PEER_IP=$(wg show wg0 allowed-ips | head -1 | awk '{print $2}' | cut -d/ -f1)
        if ping -c 3 -W 5 "$PEER_IP" >/dev/null 2>&1; then
          echo "peer_reachable"
        else
          echo "peer_unreachable"
        fi
      register: peer_connectivity
      changed_when: false
      failed_when: false
      tags: [wireguard, verify]

    - name: Display peer connectivity status
      debug:
        msg:
          - "WireGuard peer connectivity: {{ peer_connectivity.stdout }}"
          - "{% if peer_connectivity.stdout == 'no_peers' %}No peers configured yet - use wireguard-add-peer.sh to add devices{% endif %}"
          - "{% if peer_connectivity.stdout == 'peer_unreachable' %}Peer configured but not connected - check peer device is running WireGuard{% endif %}"
          - "{% if peer_connectivity.stdout == 'peer_reachable' %}✓ Peer connected and reachable{% endif %}"
      when: peer_connectivity.stdout != "peer_reachable"
      tags: [wireguard, verify]
#+end_src

** Peer Management Script

This script simplifies adding new WireGuard peers (laptops, workstations, etc.)

#+begin_src bash :tangle ../configs/templates/wireguard-add-peer.sh.j2
#!/bin/bash
# Add WireGuard peer (see 02-wireguard.org)

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ $# -lt 2 ]; then
  echo -e "${RED}Usage: $0 <peer-name> <peer-public-key>${NC}"
  echo ""
  echo "Generate keys: wg genkey | tee private.key | wg pubkey"
  echo "Add peer: $0 laptop 'AbCd...XyZ='"
  exit 1
fi

PEER_NAME="$1"
PEER_PUBKEY="$2"
WG_CONF="/etc/wireguard/wg0.conf"
SERVER_PUBKEY=$(cat /etc/wireguard/server-public.key)

if ! [[ "$PEER_NAME" =~ ^[a-zA-Z0-9_-]+$ ]]; then
  echo -e "${RED}Error: Peer name must be alphanumeric${NC}"
  exit 1
fi

if grep -q "# $PEER_NAME$" "$WG_CONF"; then
  echo -e "${RED}Error: Peer '$PEER_NAME' already exists${NC}"
  exit 1
fi

# Get next available IP
NETWORK_PREFIX="{{ wireguard_network }}"
NETWORK_PREFIX="${NETWORK_PREFIX%/*}"
NETWORK_PREFIX="${NETWORK_PREFIX%.*}"

EXISTING_IPS=$(grep "AllowedIPs = ${NETWORK_PREFIX}." "$WG_CONF" 2>/dev/null | grep -oP '(?<=\.)\d+(?=/32)' || echo "1")
LAST_IP=$(echo "$EXISTING_IPS" | sort -n | tail -1)
NEXT_IP=$((LAST_IP + 1))

[ $NEXT_IP -gt 254 ] && { echo -e "${RED}Error: No IPs available${NC}"; exit 1; }

PEER_IP="${NETWORK_PREFIX}.$NEXT_IP"

echo -e "${GREEN}=== Adding Peer: $PEER_NAME ($PEER_IP) ===${NC}"

cat >> "$WG_CONF" << EOF

# $PEER_NAME
[Peer]
PublicKey = $PEER_PUBKEY
AllowedIPs = $PEER_IP/32
EOF

wg syncconf wg0 <(wg-quick strip wg0)

echo -e "${GREEN}✓ Peer added${NC}"
echo ""
echo "Peer config:"
cat << EOF
[Interface]
Address = $PEER_IP/24
PrivateKey = <paste-from-peer-device>

[Peer]
PublicKey = $SERVER_PUBKEY
Endpoint = <YOUR-SERVER-PUBLIC-IP>:{{ wireguard_port }}
AllowedIPs = {{ wireguard_server_ip }}/32
PersistentKeepalive = 25
EOF
#+end_src

** Peer Removal Script

#+begin_src bash :tangle ../configs/templates/wireguard-remove-peer.sh.j2
#!/bin/bash
# WireGuard Peer Removal Script
# Generated from org/02-wireguard.org

set -euo pipefail

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

if [ $# -lt 1 ]; then
  echo -e "${RED}Usage: $0 <peer-name>${NC}"
  echo ""
  echo "List current peers:"
  echo -e "  ${YELLOW}wg show wg0 peers${NC}"
  echo ""
  echo "Remove a peer:"
  echo -e "  ${YELLOW}$0 laptop${NC}"
  echo ""
  exit 1
fi

PEER_NAME="$1"
WG_CONF="/etc/wireguard/wg0.conf"

# Check if peer exists
if ! grep -q "# $PEER_NAME$" "$WG_CONF"; then
  echo -e "${RED}Error: Peer '$PEER_NAME' not found${NC}"
  exit 1
fi

echo -e "${YELLOW}Removing peer: $PEER_NAME${NC}"

# Remove peer section (peer comment + [Peer] + PublicKey + AllowedIPs + blank line)
sed -i "/# $PEER_NAME$/,/^$/d" "$WG_CONF"

# Reload WireGuard
wg syncconf wg0 <(wg-quick strip wg0)

echo -e "${GREEN}✓ Peer removed successfully${NC}"
echo ""
echo "Remaining peers:"
wg show wg0 peers | while read pubkey; do
  grep -B 1 "$pubkey" "$WG_CONF" | grep "^#" | sed 's/# /  - /'
done || echo "  (none)"
#+end_src

** WireGuard Status Script

#+begin_src bash :tangle ../configs/templates/wireguard-status.sh.j2
#!/bin/bash
# WireGuard Status Script
# Generated from org/02-wireguard.org

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== WireGuard Status ===${NC}"
echo ""

# Interface status
if ip link show wg0 &>/dev/null; then
  echo -e "${GREEN}✓ Interface wg0 is UP${NC}"
else
  echo -e "${YELLOW}✗ Interface wg0 is DOWN${NC}"
fi

echo ""

# WireGuard configuration
echo "--- Configuration ---"
wg show wg0

echo ""

# Connected peers
echo "--- Connected Peers ---"
PEER_COUNT=$(wg show wg0 peers | wc -l)
if [ $PEER_COUNT -eq 0 ]; then
  echo "No peers connected"
else
  echo "$PEER_COUNT peer(s) configured:"
  wg show wg0 peers | while read pubkey; do
    PEER_NAME=$(grep -B 1 "$pubkey" /etc/wireguard/wg0.conf | grep "^#" | sed 's/# //')
    PEER_IP=$(grep -A 2 "$pubkey" /etc/wireguard/wg0.conf | grep AllowedIPs | awk '{print $3}')
    PEER_ENDPOINT=$(wg show wg0 endpoints | grep "$pubkey" | awk '{print $2}')
    PEER_HANDSHAKE=$(wg show wg0 latest-handshakes | grep "$pubkey" | awk '{print $2}')

    echo ""
    echo "  Peer: $PEER_NAME"
    echo "  IP: $PEER_IP"
    echo "  Public Key: ${pubkey:0:20}..."

    if [ -n "$PEER_ENDPOINT" ]; then
      echo "  Endpoint: $PEER_ENDPOINT"

      # Calculate time since last handshake
      if [ -n "$PEER_HANDSHAKE" ] && [ "$PEER_HANDSHAKE" != "0" ]; then
        NOW=$(date +%s)
        AGO=$((NOW - PEER_HANDSHAKE))
        echo "  Last handshake: ${AGO}s ago"
      fi
    else
      echo "  Status: Not connected"
    fi
  done
fi

echo ""
#+end_src

** Deploy Helper Scripts

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Deploy WireGuard helper scripts
      template:
        src: "../configs/templates/{{ item }}.j2"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - wireguard-add-peer.sh
        - wireguard-remove-peer.sh
        - wireguard-status.sh
      tags: [wireguard, scripts]
#+end_src

** Provision SSH Keys for Server Access

**Purpose:** These keys allow you to SSH into the server from your client machines (laptop → server).

**Not covered here:** Git hosting keys (GitHub/GitLab) are generated separately in Phase 3 after privacy configuration.

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Ensure .ssh directory exists for dev user
      file:
        path: "/home/{{ dev_user }}/.ssh"
        state: directory
        owner: "{{ dev_user }}"
        group: "{{ dev_user }}"
        mode: '0700'
      tags: [wireguard, ssh]

    - name: Provision SSH public key for dev user
      authorized_key:
        user: "{{ dev_user }}"
        key: "{{ dev_user_ssh_public_key }}"
        state: present
      when:
        - dev_user_ssh_public_key is defined
        - dev_user_ssh_public_key != ""
      tags: [wireguard, ssh]

    - name: Check SSH keys exist before restricting access
      stat:
        path: "/home/{{ dev_user }}/.ssh/authorized_keys"
      register: dev_ssh_keys
      tags: [wireguard, ssh]

    - name: Fail if no SSH keys configured
      fail:
        msg: |
          SSH keys required but not found!

          Add your SSH public key to config.yml:
            dev_user_ssh_public_key: "ssh-rsa AAAAB3NzaC1yc2E... user@laptop"

          Get it from your client machine:
            cat ~/.ssh/id_rsa.pub
      when:
        - not dev_ssh_keys.stat.exists
      tags: [wireguard, ssh]
#+end_src

** Complete SSH Hardening

Now that keys are provisioned and verified, apply full SSH hardening.

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Harden SSH configuration (after keys verified)
      lineinfile:
        path: /etc/ssh/sshd_config
        regexp: "{{ item.regexp }}"
        line: "{{ item.line }}"
        state: present
      loop:
        - { regexp: '^#?PermitRootLogin', line: 'PermitRootLogin no' }
        - { regexp: '^#?PasswordAuthentication', line: 'PasswordAuthentication no' }
        - { regexp: '^#?PubkeyAuthentication', line: 'PubkeyAuthentication yes' }
        - { regexp: '^#?X11Forwarding', line: 'X11Forwarding no' }
      notify: restart sshd
      tags: [wireguard, ssh, security]
#+end_src

** Verify WireGuard Installation

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Check WireGuard service status
      systemd:
        name: wg-quick@wg0
      register: wg_status
      tags: [wireguard, verify]

    - name: Display WireGuard status
      command: /usr/local/bin/wireguard-status.sh
      register: wg_status_output
      changed_when: false
      tags: [wireguard, verify]

    - name: Display WireGuard setup summary
      debug:
        msg:
          - "=== WireGuard Setup Complete ==="
          - ""
          - "Server public key:"
          - "{{ wg_server_pubkey['content'] | b64decode | trim }}"
          - ""
          - "Server WireGuard IP: {{ wireguard_server_ip }}"
          - "Server listen port: {{ wireguard_port }}/udp"
          - "WireGuard network: {{ wireguard_network }}"
          - ""
          - "Service status: {{ wg_status.status.ActiveState }}"
          - ""
          - "=== Next Steps ==="
          - ""
          - "1. On your laptop/workstation, generate keys:"
          - "   wg genkey | tee private.key | wg pubkey"
          - ""
          - "2. Add your laptop as a peer:"
          - "   sudo wireguard-add-peer.sh laptop <laptop-public-key>"
          - ""
          - "3. Configure laptop with provided config"
          - ""
          - "4. Test connectivity:"
          - "   ping {{ wireguard_server_ip }}"
          - "   ssh {{ dev_user }}@{{ wireguard_server_ip }}"
          - ""
          - "5. After WireGuard verified, optionally close SSH port 22:"
          - "   Edit config.yml: wireguard_only: true"
          - "   Re-run: ansible-playbook playbook.yml --tags wireguard,firewall"
          - ""
          - "Emergency access: Keep port 22 open until WireGuard is fully tested"
          - ""
          - "Status: sudo wireguard-status.sh"
          - "List peers: wg show wg0 peers"
          - ""
      tags: [wireguard, verify]
#+end_src

** Mullvad WireGuard (Tor Fallback)

*** Overview

Mullvad VPN provides a fallback connection method when Tor Browser encounters blocks (Cloudflare, crypto wallets, etc.).

Uses standard WireGuard protocol - no Mullvad-specific software needed.

*** Prerequisites

1. Create Mullvad account at https://mullvad.net
   - No personal info required
   - Payment: crypto, cash, card
   - €5/month, prepay up to 12+ months
   - Account number: 16-digit identifier

2. Generate WireGuard config
   - Login to mullvad.net
   - Account → WireGuard configuration
   - Generate new key
   - Download config file

*** Deploy Mullvad WireGuard Config

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Check if Mullvad config exists
      stat:
        path: /etc/wireguard/wg-mullvad.conf
      register: mullvad_config
      tags: [wireguard, mullvad, privacy]

    - name: Display Mullvad setup instructions
      debug:
        msg:
          - "=== Mullvad WireGuard Setup (Optional) ==="
          - ""
          - "For Tor fallback when sites block Tor Browser:"
          - ""
          - "1. Create account: https://mullvad.net"
          - "2. Generate WireGuard config at mullvad.net/account"
          - "3. Save config as: /etc/wireguard/wg-mullvad.conf"
          - "4. Set permissions: sudo chmod 600 /etc/wireguard/wg-mullvad.conf"
          - ""
          - "Multi-device: Generate separate config for each device"
          - "  - Same account number"
          - "  - Different WireGuard keys"
          - "  - Up to 5 simultaneous connections"
          - ""
          - "Manual connection:"
          - "  sudo wg-quick up wg-mullvad"
          - "  sudo wg-quick down wg-mullvad"
          - ""
          - "Browser integration configured in Phase 12"
          - ""
      when: not mullvad_config.stat.exists
      tags: [wireguard, mullvad]

    - name: Verify Mullvad config permissions
      file:
        path: /etc/wireguard/wg-mullvad.conf
        mode: '0600'
        owner: root
        group: root
      when: mullvad_config.stat.exists
      tags: [wireguard, mullvad]
#+end_src

*** Mullvad Helper Scripts

#+begin_src bash :tangle ../configs/templates/mullvad-connect.sh.j2
#!/bin/bash
# Connect to Mullvad VPN
# Generated from org/11-wireguard.org

if ! sudo test -e /etc/wireguard/wg-mullvad.conf; then
  echo "Error: /etc/wireguard/wg-mullvad.conf not found"
  echo "See Phase wireguard documentation for setup"
  exit 1
fi

if sudo wg show wg-mullvad &>/dev/null; then
  echo "Mullvad already connected"
  exit 0
fi

# Sync resolvconf state to prevent signature mismatch
sudo resolvconf -u 2>/dev/null || true

if ! sudo wg-quick up wg-mullvad 2>&1; then
  echo "Error: Failed to start Mullvad VPN" >&2
  exit 1
fi

echo "✓ Mullvad VPN connected"
#+end_src

#+begin_src bash :tangle ../configs/templates/mullvad-disconnect.sh.j2
#!/bin/bash
# Disconnect from Mullvad VPN
# Generated from org/11-wireguard.org

if ! sudo wg show wg-mullvad &>/dev/null; then
  echo "Mullvad not connected"
  exit 0
fi

sudo wg-quick down wg-mullvad
echo "✓ Mullvad VPN disconnected"
#+end_src

#+begin_src bash :tangle ../configs/templates/mullvad-status.sh.j2
#!/bin/bash
# Mullvad VPN status
# Generated from org/11-wireguard.org

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo "=== Mullvad VPN Status ==="
echo ""

if ! sudo test -e /etc/wireguard/wg-mullvad.conf; then
  echo -e "${YELLOW}Config not found: /etc/wireguard/wg-mullvad.conf${NC}"
  echo "See Phase 11 documentation for setup"
  exit 0
fi

if sudo wg show wg-mullvad &>/dev/null; then
  echo -e "${GREEN}✓ Mullvad VPN connected${NC}"
  echo ""
  sudo wg show wg-mullvad
else
  echo "Mullvad VPN: Disconnected"
  echo ""
  echo "Connect: sudo mullvad-connect.sh"
fi
#+end_src

#+begin_src yaml :tangle ../ansible/fragments/11-wireguard.yml
    - name: Deploy Mullvad helper scripts
      template:
        src: "../configs/templates/{{ item }}.j2"
        dest: "/usr/local/bin/{{ item }}"
        mode: '0755'
      loop:
        - mullvad-connect.sh
        - mullvad-disconnect.sh
        - mullvad-status.sh
      tags: [wireguard, mullvad, scripts]
#+end_src

*** Notes

**** Account Management

- Account expiry: Check at mullvad.net/account
- No auto-renewal (privacy feature)
- When expired: Connection stops working
- Add more time: Login and pay
- Config file stays valid

**** Multi-Device Usage

Same account across devices:
- Server: /etc/wireguard/wg-mullvad.conf
- Laptop: WireGuard app + downloaded config
- iPhone: WireGuard app (App Store) + QR code scan

Each device needs separate config (different keys, same account).

**** Privacy Model

Mullvad provides commercial VPN service:
- No logs policy (independently audited)
- Anonymous signup (no personal info)
- Swedish jurisdiction (strong privacy laws)
- Crypto payment available

**Threat model:** Protects against website tracking, not nation-state surveillance.

**Integration:** Browser dispatcher routes specific domains through Mullvad (Phase 12).

** Notes

*** Quick Operations

After setup:
- Add peer: sudo wireguard-add-peer.sh laptop <pubkey>
- Remove peer: sudo wireguard-remove-peer.sh laptop
- Status: sudo wireguard-status.sh
- Close SSH port 22: Set wireguard_only: true in config.yml

** Overview

This phase sets up the Monero full node (monerod) - core infrastructure for sovereign cryptocurrency validation.

See Appendix G: Why Run Each Component (Monero Full Node) for rationale and resource requirements.

** Install monerod

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    # ------------------------------------------------------------------------
    # Monero Full Node
    # ------------------------------------------------------------------------

    - name: Install monerod dependencies
      community.general.pacman:
        name:
          - curl
          - tar
          - jq
        state: present
      tags: [monerod]

    - name: Set versioned monerod directory
      set_fact:
        monerod_versioned_dir: "{{ monerod_install_dir }}-{{ monerod_version }}"
      tags: [monerod]

    - name: Check if this monerod version is already installed
      stat:
        path: "{{ monerod_versioned_dir }}/monerod"
      register: monerod_version_exists
      tags: [monerod]

    - name: Download Monero release from getmonero.org
      get_url:
        url: "https://downloads.getmonero.org/cli/monero-linux-x64-{{ monerod_version }}.tar.bz2"
        dest: /tmp/monero.tar.bz2
        mode: '0644'
      when: not monerod_version_exists.stat.exists
      register: monero_download
      tags: [monerod]

    - name: Download Monero hashes
      get_url:
        url: "https://www.getmonero.org/downloads/hashes.txt"
        dest: /tmp/monero-hashes.txt
        mode: '0644'
      when: not monerod_version_exists.stat.exists
      tags: [monerod]

    - name: Extract expected hash for downloaded file
      shell: |
        grep "monero-linux-x64-{{ monerod_version }}.tar.bz2" /tmp/monero-hashes.txt | awk '{print $1}'
      register: expected_hash
      changed_when: false
      when: not monerod_version_exists.stat.exists
      tags: [monerod]

    - name: Verify download hash
      stat:
        path: /tmp/monero.tar.bz2
        checksum_algorithm: sha256
      register: download_stat
      when: not monerod_version_exists.stat.exists
      tags: [monerod]

    - name: Fail if hash mismatch
      fail:
        msg: |
          Hash verification failed!
          Expected: {{ expected_hash.stdout }}
          Got: {{ download_stat.stat.checksum }}
      when:
        - not monerod_version_exists.stat.exists
        - download_stat.stat.checksum != expected_hash.stdout
      tags: [monerod]

    - name: Create versioned Monero directory
      file:
        path: "{{ monerod_versioned_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      when: not monerod_version_exists.stat.exists
      tags: [monerod]

    - name: Extract Monero release to versioned directory
      unarchive:
        src: /tmp/monero.tar.bz2
        dest: "{{ monerod_versioned_dir }}"
        remote_src: yes
        extra_opts: [--strip-components=1]
      when: not monerod_version_exists.stat.exists
      register: monero_extract
      tags: [monerod]

    - name: Verify monerod binary exists in versioned directory
      stat:
        path: "{{ monerod_versioned_dir }}/monerod"
      register: monerod_versioned_binary
      tags: [monerod]

    - name: Fail if monerod not found after installation
      fail:
        msg: |
          Monerod binary not found after extraction.

          Possible issues:
          - Invalid version specified: {{ monerod_version }}
          - Archive structure changed
          - Download corrupted

          Check https://github.com/monero-project/monero/releases for valid versions.
      when: not monerod_versioned_binary.stat.exists
      tags: [monerod]

    - name: Update monerod symlink to current version
      file:
        src: "{{ monerod_versioned_dir }}"
        dest: "{{ monerod_install_dir }}"
        state: link
        force: yes
      notify: restart monerod
      tags: [monerod]

    - name: Create symlink to monerod in PATH
      file:
        src: "{{ monerod_install_dir }}/monerod"
        dest: /usr/local/bin/monerod
        state: link
        force: yes
      tags: [monerod]

    - name: Clean up download files
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - /tmp/monero.tar.bz2
        - /tmp/monero-hashes.txt
      when: monero_extract.changed
      tags: [monerod]
#+end_src

** Create Data Directory

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Create monerod data directory
      file:
        path: "{{ monerod_data_dir }}"
        state: directory
        owner: root
        group: root
        mode: '0755'
      tags: [monerod]

    - name: Create monerod log directory
      file:
        path: "{{ monerod_data_dir }}/logs"
        state: directory
        owner: root
        group: root
        mode: '0755'
      tags: [monerod]
#+end_src

** I2P Configuration

Create directory for I2P address storage. The actual address is fetched dynamically at monerod startup.

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Create monero config directory
      file:
        path: /etc/monero
        state: directory
        mode: '0755'
      tags: [monerod, config]
#+end_src

** I2P Tunnel Wait Script

This script waits for the I2P tunnel to be ready and fetches the current address.
I2P tunnels can take 1-5 minutes to establish on first startup or after i2pd restart.

The script is called by monerod's systemd service ExecStartPre to ensure the tunnel
exists before monerod attempts to use it.

#+begin_src bash :tangle ../configs/templates/wait-for-i2p-tunnel.sh.j2
#!/bin/bash
# Wait for I2P tunnel to be ready and fetch address
# Used by monerod.service ExecStartPre

set -e

MAX_WAIT=300  # 5 minutes max
ELAPSED=0

echo "Waiting for i2pd web console..."
while [ $ELAPSED -lt $MAX_WAIT ]; do
  if curl -s --max-time 2 http://127.0.0.1:7070 >/dev/null 2>&1; then
    break
  fi
  sleep 2
  ELAPSED=$((ELAPSED + 2))
done

if [ $ELAPSED -ge $MAX_WAIT ]; then
  echo "ERROR: i2pd web console not available after ${MAX_WAIT}s" >&2
  exit 1
fi

echo "Waiting for monero-node I2P tunnel..."
ELAPSED=0
while [ $ELAPSED -lt $MAX_WAIT ]; do
  I2P_ADDR=$(curl -s --max-time 5 http://127.0.0.1:7070/?page=i2p_tunnels | \
    grep -oP 'monero-node.*?([a-z0-9]{52}\.b32\.i2p)' | \
    grep -oP '[a-z0-9]{52}\.b32\.i2p' | \
    head -1)

  if [ -n "$I2P_ADDR" ] && [[ "$I2P_ADDR" =~ ^[a-z0-9]{52}\.b32\.i2p$ ]]; then
    echo "$I2P_ADDR" > /etc/monero/i2p-address.txt
    chmod 644 /etc/monero/i2p-address.txt
    echo "I2P tunnel ready: $I2P_ADDR"
    exit 0
  fi

  sleep 5
  ELAPSED=$((ELAPSED + 5))
done

echo "ERROR: monero-node I2P tunnel not ready after ${MAX_WAIT}s" >&2
exit 1
#+end_src

** Download and Configure Spy Node Ban List

The ban list blocks known spy nodes that attempt to link IP addresses to transactions.
Updates are **automated weekly** (Sundays at 3 AM) with safety checks.

See Appendix G: GPG Signature Verification (Ban List) for security rationale.

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Download Monero spy node ban list
      get_url:
        url: https://raw.githubusercontent.com/Boog900/monero-ban-list/refs/heads/main/ban_list.txt
        dest: /etc/monero/ban_list.txt
        mode: '0644'
        force: no
      register: ban_list_download
      tags: [monerod, config, security]

    - name: Verify ban list downloaded successfully
      stat:
        path: /etc/monero/ban_list.txt
      register: ban_list_file
      tags: [monerod, config, security]

    - name: Check ban list has content
      shell: wc -l /etc/monero/ban_list.txt | awk '{print $1}'
      register: ban_list_lines
      changed_when: false
      tags: [monerod, config, security, verify]

    - name: Display ban list stats
      debug:
        msg:
          - "Ban list downloaded: {{ ban_list_file.stat.exists }}"
          - "Ban list entries: {{ ban_list_lines.stdout }}"
          - ""
          - "Note: GPG signatures not verified (keys must come from same potentially"
          - "compromised hosts). Relying on HTTPS + size validation instead."
          - "For manual verification: https://github.com/Boog900/monero-ban-list#signatures"
      tags: [monerod, config, security]
#+end_src

** monerod Configuration

#+begin_src ini :tangle ../configs/templates/monerod.conf.j2
# Monero Full Node Configuration
# Generated from org/03-monerod.org

# ============================================================================
# Data Storage
# ============================================================================

data-dir={{ monerod_data_dir }}
log-file={{ monerod_data_dir }}/logs/monerod.log
log-level=0
max-log-file-size=104857600  # 100MB

# ============================================================================
# Network Configuration
# ============================================================================

# P2P network
p2p-bind-ip=0.0.0.0
p2p-bind-port=18080

# Peer connections
out-peers={{ monerod_out_peers }}
in-peers={{ monerod_in_peers }}

# Bandwidth limits (KB/s, 0 = unlimited)
limit-rate-up={{ monerod_limit_rate_up }}
limit-rate-down={{ monerod_limit_rate_down }}

# ============================================================================
# Privacy: I2P Network
# ============================================================================

# NOTE: I2P configuration provided via systemd ExecStart command-line flags
# Command-line flags are more reliable than config file for I2P in v0.18.x
# See: monerod.service.j2 template
#
# I2P configuration (command-line only):
# - Transaction broadcast: --tx-proxy i2p,127.0.0.1:7656
# - P2P inbound: --anonymous-inbound <i2p-address>,127.0.0.1:18085,128
#
# Block known spy nodes (MRL recommended)
# List maintained by Monero Research Lab
# https://github.com/monero-project/meta/issues/1124
ban-list=/etc/monero/ban_list.txt

# Note: Blockchain sync uses clearnet (intentional - sybil protection)
# See: https://github.com/monero-project/monero/blob/master/docs/ANONYMITY_NETWORKS.md

# ============================================================================
# RPC Configuration (Localhost Only)
# ============================================================================

rpc-bind-ip={{ monerod_rpc_bind_ip }}
rpc-bind-port={{ monerod_rpc_port }}
confirm-external-bind=1

# ZMQ notifications (REQUIRED by P2Pool)
# P2Pool monitors block notifications via ZMQ pub-sub
# Without this, P2Pool cannot detect new blocks for mining
zmq-pub=tcp://127.0.0.1:{{ monerod_zmq_port }}

# Restricted RPC (security - no wallet operations, mining control, etc.)
{% if monerod_restricted_rpc %}
restricted-rpc=1
{% endif %}

# ============================================================================
# Mining: DISABLED (XMRig handles mining)
# ============================================================================

# monerod's built-in miner is disabled
# Mining is done by XMRig (much faster, optimized)

# ============================================================================
# Performance
# ============================================================================

# Database sync mode (safe for SSD)
db-sync-mode=safe

# Use multiple threads for verification
prep-blocks-threads={{ ansible_facts['processor_vcpus'] | default(4) }}

# Block verification threads
block-sync-size=10

# ============================================================================
# Privacy
# ============================================================================

# Don't reveal your node version
hide-my-port=0
no-igd=1
enable-dns-blocklist=1

# ============================================================================
# Maintenance
# ============================================================================

# Prune blockchain (keeps last 3 months, saves ~130GB)
# Uncomment to enable pruning:
# prune-blockchain=1

# Check for updates (doesn't auto-update)
check-updates=disabled
#+end_src

** Deploy Configuration

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Deploy monerod configuration
      template:
        src: ../configs/templates/monerod.conf.j2
        dest: /etc/monerod.conf
        mode: '0644'
        owner: root
        group: root
      notify: restart monerod
      tags: [monerod, config]

    - name: Deploy I2P tunnel wait script
      template:
        src: ../configs/templates/wait-for-i2p-tunnel.sh.j2
        dest: /usr/local/bin/wait-for-i2p-tunnel.sh
        mode: '0755'
      tags: [monerod, config]
#+end_src

** monerod Systemd Service

#+begin_src ini :tangle ../configs/templates/monerod.service.j2
[Unit]
Description=Monero Full Node
After=network-online.target i2pd.service
Wants=network-online.target
Requires=i2pd.service

[Service]
Type=simple
User=root
Group=root
WorkingDirectory={{ monerod_data_dir }}

# Wait for I2P tunnel to be ready before starting
ExecStartPre=/usr/local/bin/wait-for-i2p-tunnel.sh

ExecStart={{ monerod_install_dir }}/monerod \
    --config-file /etc/monerod.conf \
    --tx-proxy i2p,127.0.0.1:7656 \
    --anonymous-inbound $(cat /etc/monero/i2p-address.txt),127.0.0.1:18085,128 \
    --non-interactive

Restart=always
RestartSec=10
Nice=5

# Resource limits
MemoryMax=4G
CPUQuota=100%

# Security hardening
NoNewPrivileges=true
PrivateTmp=true
ProtectSystem=full
ProtectHome=true
ReadWritePaths=/etc/monero

[Install]
WantedBy=multi-user.target
#+end_src

** Deploy Service

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Deploy monerod systemd service
      template:
        src: ../configs/templates/monerod.service.j2
        dest: /etc/systemd/system/monerod.service
        mode: '0644'
      notify: reload systemd
      tags: [monerod, systemd]

    - name: Reload systemd daemon for monerod
      systemd:
        daemon_reload: yes
      tags: [monerod, systemd]

    - name: Enable and start monerod
      systemd:
        name: monerod
        enabled: yes
        state: started
      tags: [monerod, systemd]
#+end_src

** Firewall Configuration

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Allow Monero P2P port through firewall
      community.general.ufw:
        rule: allow
        port: 18080
        proto: tcp
        comment: "Monero P2P"
      tags: [monerod, firewall]
#+end_src

** monerod Status Script

#+begin_src bash :tangle ../configs/templates/monerod-status.sh.j2
#!/bin/bash
# Monero Full Node Status Script
# Generated from org/03-monerod.org

GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

echo -e "${GREEN}=== Monero Full Node Status ===${NC}"
echo ""

# Service status
if systemctl is-active --quiet monerod; then
  echo -e "${GREEN}✓ monerod service running${NC}"
else
  echo -e "${YELLOW}✗ monerod service NOT running${NC}"
  exit 1
fi

echo ""

# Sync status via RPC
INFO=$(curl -s --max-time 5 http://127.0.0.1:18081/json_rpc \
  -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
  -H 'Content-Type: application/json' | jq -r '.result')

if [ -n "$INFO" ] && [ "$INFO" != "null" ]; then
  HEIGHT=$(echo "$INFO" | jq -r '.height')
  SYNCHRONIZED=$(echo "$INFO" | jq -r '.synchronized')

  if [ "$SYNCHRONIZED" = "true" ]; then
    echo -e "${GREEN}✓ Blockchain synced${NC}"
    echo "  Current height: $HEIGHT"
  else
    echo -e "${YELLOW}⚠ Still syncing${NC}"
    echo "  Current height: $HEIGHT"
  fi
else
  echo -e "${YELLOW}⚠ Could not fetch sync status${NC}"
  echo "  (monerod may still be starting)"
fi

echo ""

# Connection info
INFO=$(curl -s --max-time 5 http://127.0.0.1:18081/json_rpc \
  -d '{"jsonrpc":"2.0","id":"0","method":"get_info"}' \
  -H 'Content-Type: application/json' | jq -r '.result')

if [ -n "$INFO" ] && [ "$INFO" != "null" ]; then
  INCOMING=$(echo "$INFO" | jq -r '.incoming_connections_count')
  OUTGOING=$(echo "$INFO" | jq -r '.outgoing_connections_count')
  TX_POOL=$(echo "$INFO" | jq -r '.tx_pool_size')

  echo "--- Network Connections ---"
  echo "  Incoming: $INCOMING"
  echo "  Outgoing: $OUTGOING"
  echo "  TX pool: $TX_POOL transactions"
fi

echo ""

# Disk usage
DISK_USAGE=$(du -sh /opt/monerod 2>/dev/null | cut -f1)
echo "--- Storage ---"
echo "  Blockchain size: ${DISK_USAGE:-calculating...}"

echo ""
echo "--- Commands ---"
echo "  Logs: journalctl -u monerod -f"
echo "  Restart: systemctl restart monerod"
echo "  Status: systemctl status monerod"
echo ""
#+end_src

** Deploy Status Script

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Deploy monerod status script
      template:
        src: ../configs/templates/monerod-status.sh.j2
        dest: /usr/local/bin/monerod-status.sh
        mode: '0755'
      tags: [monerod, scripts]
#+end_src

** Ban List Maintenance

Script to update the ban list weekly with safety checks.

#+begin_src bash :tangle ../configs/templates/update-monero-banlist.sh.j2
#!/bin/bash
# Ban list update (see 05-monerod.org)

set -euo pipefail

TEMP_FILE="/tmp/ban_list.txt.tmp"
BAN_LIST="/etc/monero/ban_list.txt"

curl -s https://raw.githubusercontent.com/Boog900/monero-ban-list/refs/heads/main/ban_list.txt -o "$TEMP_FILE"

if [ ! -f "$TEMP_FILE" ] || [ ! -s "$TEMP_FILE" ]; then
  echo "ERROR: Failed to download ban list" >&2
  exit 1
fi

NEW_COUNT=$(wc -l < "$TEMP_FILE")
OLD_COUNT=$(wc -l < "$BAN_LIST" 2>/dev/null || echo 0)

# Check for suspicious size changes (>50% suggests corruption/attack)
if [ "$OLD_COUNT" -gt 0 ]; then
  DIFF_RAW=$(( (NEW_COUNT - OLD_COUNT) * 100 / OLD_COUNT ))
  DIFF=${DIFF_RAW#-}

  if [ "$DIFF" -gt 50 ]; then
    echo "WARNING: Ban list size changed by ${DIFF}% (old: $OLD_COUNT, new: $NEW_COUNT)" >&2
    echo "Possible corruption or malicious update. Manual review required." >&2
    exit 1
  fi
fi

mv "$TEMP_FILE" "$BAN_LIST"
chmod 644 "$BAN_LIST"

if systemctl is-active --quiet monerod && [ "$NEW_COUNT" != "$OLD_COUNT" ]; then
  echo "Ban list updated ($OLD_COUNT -> $NEW_COUNT entries). Restarting monerod..."
  systemctl restart monerod
  logger -t monero-ban-list "Ban list updated: $OLD_COUNT -> $NEW_COUNT entries"
else
  echo "Ban list up to date ($NEW_COUNT entries)"
fi
#+end_src

Deploy the script and set up weekly updates.

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Deploy ban list update script
      template:
        src: ../configs/templates/update-monero-banlist.sh.j2
        dest: /usr/local/bin/update-monero-banlist.sh
        mode: '0755'
      tags: [monerod, scripts, security]

    - name: Create weekly ban list update cron job (Sundays 3 AM)
      cron:
        name: "Update Monero spy node ban list"
        minute: "0"
        hour: "3"
        weekday: "0"
        job: "/usr/local/bin/update-monero-banlist.sh >> /var/log/monero-banlist.log 2>&1"
        user: root
      tags: [monerod, cron, security]
#+end_src

** Verification

#+begin_src yaml :tangle ../ansible/fragments/15-monerod.yml
    - name: Wait for monerod to start
      pause:
        seconds: 10
      tags: [monerod, verify]

    - name: Verify ZMQ port is listening
      wait_for:
        host: 127.0.0.1
        port: "{{ monerod_zmq_port }}"
        timeout: 30
        msg: "ZMQ port {{ monerod_zmq_port }} not listening - P2Pool will not work"
      tags: [monerod, verify]

    - name: Display ZMQ status
      debug:
        msg:
          - "✓ ZMQ pub-sub listening on port {{ monerod_zmq_port }}"
          - ""
          - "P2Pool will use this to detect new Monero blocks"
          - "If P2Pool shows ZMQ errors, verify this port is accessible"
      tags: [monerod, verify]

    - name: Check monerod service status
      systemd:
        name: monerod
      register: monerod_status
      tags: [monerod, verify]

    - name: Test monerod RPC connectivity
      uri:
        url: "http://127.0.0.1:{{ monerod_rpc_port }}/json_rpc"
        method: POST
        body_format: json
        body:
          jsonrpc: "2.0"
          id: "0"
          method: "get_info"
        timeout: 10
      register: monerod_rpc_test
      failed_when: false
      tags: [monerod, verify]

    - name: Display monerod setup summary
      debug:
        msg:
          - "=== Monero Full Node Setup Complete ==="
          - ""
          - "Service: {{ monerod_status.status.ActiveState }}"
          - "Data directory: {{ monerod_data_dir }}"
          - "RPC endpoint: http://127.0.0.1:{{ monerod_rpc_port }}"
          - "ZMQ pub-sub: tcp://127.0.0.1:{{ monerod_zmq_port }} (REQUIRED by P2Pool)"
          - "P2P port: 18080"
          - ""
          - "Privacy configuration:"
          - "  I2P address: Fetched dynamically at startup"
          - "  Transaction broadcast: I2P (primary) + Tor (fallback)"
          - "  Blockchain sync: Clearnet (sybil protection)"
          - "  Spy node protection: Ban list enabled ({{ ban_list_lines.stdout }} entries)"
          - ""
          - "Bandwidth limits:"
          - "  Upload: {{ monerod_limit_rate_up }} KB/s"
          - "  Download: {{ monerod_limit_rate_down }} KB/s"
          - ""
          - "Peer connections:"
          - "  Outgoing: {{ monerod_out_peers }}"
          - "  Incoming: {{ monerod_in_peers }}"
          - ""
          - "=== Initial Sync ==="
          - "Blockchain sync will take 6-24 hours depending on:"
          - "  - Internet speed"
          - "  - CPU performance"
          - "  - Disk I/O"
          - ""
          - "Monitor sync progress:"
          - "  sudo monerod-status.sh"
          - "  journalctl -u monerod -f"
          - ""
          - "Ban list updates: Weekly (Sundays at 3 AM)"
          - "Manual update: sudo update-monero-banlist.sh"
          - "Check status: tail /var/log/monero-banlist.log"
          - ""
          - "P2Pool will automatically use this node once sync completes"
          - ""
      tags: [monerod, verify]
#+end_src

** Notes

*** Quick Operations

#+begin_example
# Status and monitoring
sudo monerod-status.sh
journalctl -u monerod -f

# Maintenance
systemctl restart monerod
du -sh /opt/monerod  # Check disk usage
#+end_example

*** Spy Node Ban List

The ban list blocks known spy nodes that attempt to link IP addresses to transactions.

**Automated updates:**
- Runs weekly (Sundays at 3 AM)
- Downloads from: https://github.com/Boog900/monero-ban-list
- Size validation prevents corruption/attacks (>50% change triggers manual review)
- Automatically restarts monerod if list changes

**Maintained by:** Monero Research Lab
**Source:** https://github.com/Boog900/monero-ban-list
**MRL issue:** https://github.com/monero-project/meta/issues/1124

*Security model:*

** Network Privacy

Monero uses defense-in-depth: blockchain sync on clearnet, transactions via I2P primary + Tor fallback, P2P via I2P hidden service.

See Appendix F: Threat Models for detailed architecture rationale.

*** Troubleshooting

See Appendix H: Phase-Specific Quick Fixes (Monero Full Node) for detailed troubleshooting.

Official docs: https://monerodocs.org

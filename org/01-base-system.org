** Overview

This phase sets up the base system:
- System updates
- Essential packages
- System configuration (timezone, locale, hostname)
- Kernel parameters
- Verification of disk encryption

** Playbook Header

All phases append to the same playbook. This starts the main play.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
---
# ============================================================================
# Literate Monero Installation Playbook
# ============================================================================
# Generated from install.org via Org-mode tangling (C-c C-v t)
# Do not edit this file directly - edit org/*.org files instead

- name: Literate Monero Complete Setup
  hosts: localhost
  become: true
  vars_files:
    - group_vars/all.yml
    - ../config.yml

  tasks:
#+end_src

** Essential Packages

Install tools needed for system administration and development.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Install essential system packages
      community.general.pacman:
        name:
          - base-devel
          - git
          - curl
          - wget
          - htop
          - tmux
          - vim
          - ufw
          - rsync
          - unzip
          - zip
          - net-tools
          - dnsutils
          - bind-tools
          - cronie
          - openbsd-netcat
        state: present
      tags: [base, packages]
#+end_src

** Enable Cron Service

Enable cronie for scheduled tasks (used by monitoring and backup).

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Enable and start cronie service
      systemd:
        name: cronie
        enabled: yes
        state: started
      tags: [base, services]
#+end_src

** System Configuration

Set timezone, locale, and hostname.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Set system timezone
      community.general.timezone:
        name: "{{ system_timezone }}"
      tags: [base, config]

    - name: Generate locale
      community.general.locale_gen:
        name: "{{ system_locale }}"
        state: present
      tags: [base, config]

    - name: Set system locale
      copy:
        content: |
          LANG={{ system_locale }}
          LC_ALL={{ system_locale }}
        dest: /etc/locale.conf
        mode: '0644'
      tags: [base, config]

    - name: Set hostname
      hostname:
        name: "{{ system_hostname }}"
      tags: [base, config]

    - name: Update /etc/hosts
      lineinfile:
        path: /etc/hosts
        regexp: '^127\.0\.0\.1'
        line: "127.0.0.1 localhost {{ system_hostname }}"
      tags: [base, config]
#+end_src

** Kernel Parameters

Configure kernel parameters for mining optimization (huge pages).

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Set kernel parameters for mining
      sysctl:
        name: "{{ item.name }}"
        value: "{{ item.value }}"
        state: present
        reload: true
      loop: "{{ kernel_params }}"
      tags: [base, kernel]

    - name: Make kernel parameters persistent
      lineinfile:
        path: /etc/sysctl.d/99-mining.conf
        line: "{{ item.name }} = {{ item.value }}"
        create: yes
        mode: '0644'
      loop: "{{ kernel_params }}"
      tags: [base, kernel]
#+end_src

** Swap Configuration

Configure swap with low swappiness for server workload.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Set swappiness
      sysctl:
        name: vm.swappiness
        value: "{{ swappiness }}"
        state: present
        reload: yes
      tags: [base, swap]

    - name: Make swappiness persistent
      lineinfile:
        path: /etc/sysctl.d/99-swap.conf
        line: "vm.swappiness = {{ swappiness }}"
        create: yes
        mode: '0644'
      tags: [base, swap]
#+end_src

** Verify Encryption

Check that the root partition is encrypted with LUKS.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Check if root partition is encrypted
      shell: |
        if lsblk -f | grep -q crypto_LUKS; then
          echo "encrypted"
        else
          echo "not encrypted"
        fi
      register: encryption_check
      changed_when: false
      tags: [base, verify]

    - name: Display encryption status
      debug:
        msg: "Root partition: {{ encryption_check.stdout }}"
      tags: [base, verify]

    - name: Warn if not encrypted
      debug:
        msg: "WARNING: Root partition does not appear to be encrypted!"
      when: "'not encrypted' in encryption_check.stdout"
      tags: [base, verify]
#+end_src

** System Information

Display system information for verification.

#+begin_src yaml :tangle ../ansible/fragments/01-base-system.yml
    - name: Gather system facts
      setup:
      tags: [base, info]

    - name: Display system information
      debug:
        msg:
          - "=== System Information ==="
          - "Distribution: {{ ansible_facts['distribution'] }} {{ ansible_facts['distribution_version'] }}"
          - "Kernel: {{ ansible_facts['kernel'] }}"
          - "Architecture: {{ ansible_facts['architecture'] }}"
          - "CPUs: {{ ansible_facts['processor_vcpus'] }}"
          - "CPU Model: {{ ansible_facts['processor'][2] }}"
          - "Total Memory: {{ ansible_facts['memtotal_mb'] }} MB"
          - "Hostname: {{ ansible_facts['hostname'] }}"
          - "Timezone: {{ system_timezone }}"
      tags: [base, info]
#+end_src

** Notes

*** Huge Pages

Huge pages improve mining performance by reducing TLB misses.

We allocate 1280 huge pages (2MB each = 2.5GB total).

Verify with:
#+begin_example
cat /proc/meminfo | grep Huge
#+end_example

*** Swappiness

Low swappiness (10) means the kernel prefers to keep things in RAM.

Good for servers with plenty of RAM.

*** SSH Security

- Root login disabled
- Password authentication disabled (keys only)
- X11 forwarding disabled

Make sure you have SSH keys set up before applying!

The playbook will check for SSH keys and fail if none are found with password auth disabled.